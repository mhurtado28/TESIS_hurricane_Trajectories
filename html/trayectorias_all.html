
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano &#8212; Trayectorias de Huracanes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'trayectorias_all';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
  
    <p class="title logo__title">Trayectorias de Huracanes</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/trayectorias_all.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objetivo-general">Objetivo General</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objetivos-especificos">Objetivos Específicos</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias">Librerías</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#etl">ETL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organizacion-del-dataframe">organización del dataframe</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajustando-las-coordenadas-a-un-formato-numerico">ajustando las coordenadas a un formato numérico</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajuste-de-los-targets-de-la-variable-type-storm-y-el-codigo-de-tormenta-code-storm">ajuste de los targets de la variable Type_storm y el Codigo de tormenta (Code_storm)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajuste-en-los-datos-de-fecha">Ajuste en los datos de fecha</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-verifican-datos-duplicados-y-se-reemplaza-99-por-nan">Se verifican datos duplicados y se reemplaza -99 por NaN</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eliminacion-de-la-variable-rad-max-wind">Eliminación de la variable Rad_Max_wind</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#eda-1">EDA #1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datos-faltantes">Datos faltantes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploracion-de-los-radios-del-viento">Exploración de los Radios del viento</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agregar-categorias-de-huracan-type-storm-numerico">Agregar Categorias de Huracan &amp; “type_storm” numérico</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imputacion-de-presion-minima-minpress">Imputación de Presión Mínima “Minpress”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imputaciones">IMPUTACIONES</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-vector-de-longitud">Cálculo de vector de longitud</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-la-direccion-de-la-tormenta">Calculo de la dirección de la tormenta</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#generico-pruebas">Generico pruebas</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#split">Split</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-knn">Modelo KNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-decission-tree">Modelo Decission tree</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-xgboost">Modelo XGBoost</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-svr">Modelo SVR</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-mlp">Modelo MLP</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-rnn">Modelo de RNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-lstm">Modelo de LSTM</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-n-beast-bayesian">Modelo  N-Beast Bayesian</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-de-training">Resultado de Training</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-validacion">Resultado validación</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados-test">Resultados Test</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="predecir-la-trayectoria-e-intensidad-de-huracanes-aplicando-modelos-de-aprendizaje-automatico-con-enfoque-en-aquellos-que-amenacen-las-islas-de-san-andres-y-providencia-caribe-colombiano">
<h1>Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano<a class="headerlink" href="#predecir-la-trayectoria-e-intensidad-de-huracanes-aplicando-modelos-de-aprendizaje-automatico-con-enfoque-en-aquellos-que-amenacen-las-islas-de-san-andres-y-providencia-caribe-colombiano" title="Link to this heading">#</a></h1>
<section id="objetivo-general">
<h2>Objetivo General<a class="headerlink" href="#objetivo-general" title="Link to this heading">#</a></h2>
<p>Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano.</p>
</section>
<section id="objetivos-especificos">
<h2>Objetivos Específicos<a class="headerlink" href="#objetivos-especificos" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Realizar extracción, transformación y carga (ETL) de datos mediante reglas para limpiar y organizar datos en bruto y prepararlos para el almacenamiento, el análisis de datos e implementación de modelos de ML para la predicción de la trayectoria e intensidad de huracanes.</p></li>
<li><p>Realizar un Análisis Exploratorio de Datos (EDA) con base en la matriz de datos elaborada, como mecanismo para la detección de patrones importantes, datos faltantes y atípicos a tratar, así como también, el preprocesamiento de cada una de las variables de entrada de los modelos de aprendizaje automático, para la predicción de la trayectoria e intensidad de huracanes.</p></li>
<li><p>Implementar y evaluar distintos modelos estadísticos y de aprendizaje automático para la predicción de la trayectoria e intensidad de huracanes, mediante el uso de métricas de evaluación y validación cruzada adecuadas, así como métodos de optimización para la selección de parámetros.</p></li>
</ul>
<section id="librerias">
<h3>Librerías<a class="headerlink" href="#librerias" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">geodesic</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">joblib</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="etl">
<h1>ETL<a class="headerlink" href="#etl" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">geodesic</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;hurdat2-1851-2023-051124.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Hour&#39;</span><span class="p">,</span><span class="s1">&#39;RecIdentifier&#39;</span><span class="p">,</span><span class="s1">&#39;type_storm&#39;</span><span class="p">,</span><span class="s1">&#39;Latitude&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">,</span><span class="s1">&#39;MinPress&#39;</span><span class="p">,</span><span class="s1">&#39;NE34&#39;</span><span class="p">,</span><span class="s1">&#39;SE34&#39;</span><span class="p">,</span><span class="s1">&#39;SW34&#39;</span><span class="p">,</span><span class="s1">&#39;NW34&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;NE50&#39;</span><span class="p">,</span><span class="s1">&#39;SE50&#39;</span><span class="p">,</span><span class="s1">&#39;SW50&#39;</span><span class="p">,</span><span class="s1">&#39;NW50&#39;</span><span class="p">,</span><span class="s1">&#39;NE64&#39;</span><span class="p">,</span><span class="s1">&#39;SE64&#39;</span><span class="p">,</span><span class="s1">&#39;SW64&#39;</span><span class="p">,</span><span class="s1">&#39;NW64&#39;</span><span class="p">,</span><span class="s1">&#39;Rad_Max_Wind&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Hour</th>
      <th>RecIdentifier</th>
      <th>type_storm</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>NE34</th>
      <th>SE34</th>
      <th>...</th>
      <th>NW34</th>
      <th>NE50</th>
      <th>SE50</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Rad_Max_Wind</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18510625</td>
      <td>0000</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>94.8W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18510625</td>
      <td>0600</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>95.4W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18510625</td>
      <td>1200</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>96.0W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18510625</td>
      <td>1800</td>
      <td></td>
      <td>HU</td>
      <td>28.1N</td>
      <td>96.5W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<section id="organizacion-del-dataframe">
<h2>organización del dataframe<a class="headerlink" href="#organizacion-del-dataframe" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Agregar nuevas columnas para almacenar los valores extraídos</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Name_storm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Trackets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Variables temporales para almacenar los valores</span>
<span class="n">current_code</span><span class="p">,</span> <span class="n">current_name</span><span class="p">,</span> <span class="n">current_rec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AL&quot;</span><span class="p">):</span>
        <span class="n">current_code</span><span class="p">,</span> <span class="n">current_name</span><span class="p">,</span> <span class="n">current_rec</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Hour&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;RecIdentifier&quot;</span><span class="p">]</span>

    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_code</span>
    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Name_storm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_name</span>
    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Trackets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_rec</span>


<span class="c1"># Eliminar filas donde la columna &quot;Date&quot; comienza con &quot;AL&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AL&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Reubicar las columnas code_storm, name_storm y recIdentifier al inicio</span>
<span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">,</span> <span class="s2">&quot;Name_storm&quot;</span><span class="p">,</span> <span class="s2">&quot;Trackets&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">,</span> <span class="s2">&quot;Name_storm&quot;</span><span class="p">,</span> <span class="s2">&quot;Trackets&quot;</span><span class="p">]]</span>
<span class="n">df_procesado</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/687664288.py:13: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;AL011851&#39; has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  df.at[index, &quot;Code_storm&quot;] = current_code
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/687664288.py:14: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;            UNNAMED&#39; has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  df.at[index, &quot;Name_storm&quot;] = current_name
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/687664288.py:15: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;     14&#39; has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  df.at[index, &quot;Trackets&quot;] = current_rec
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Hour</th>
      <th>RecIdentifier</th>
      <th>type_storm</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>NE34</th>
      <th>SE34</th>
      <th>...</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Rad_Max_Wind</th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>Trackets</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18510625</td>
      <td>0000</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>94.8W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18510625</td>
      <td>0600</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>95.4W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18510625</td>
      <td>1200</td>
      <td></td>
      <td>HU</td>
      <td>28.0N</td>
      <td>96.0W</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 24 columns</p>
</div></div></div>
</div>
</section>
<section id="ajustando-las-coordenadas-a-un-formato-numerico">
<h2>ajustando las coordenadas a un formato numérico<a class="headerlink" href="#ajustando-las-coordenadas-a-un-formato-numerico" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extraer el valor numérico y convertirlo a formato numérico</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Lat_N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+\.\d+)&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Lon_W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Longitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+\.\d+)&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="c1"># Eliminar las columnas originales &#39;Latitude&#39; y &#39;Longitude&#39;</span>
<span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/2514829948.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_procesado[&#39;Lat_N&#39;] = pd.to_numeric(df_procesado[&#39;Latitude&#39;].str.extract(r&#39;(\d+\.\d+)&#39;, expand=False))
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/2514829948.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_procesado[&#39;Lon_W&#39;] = pd.to_numeric(df_procesado[&#39;Longitude&#39;].str.extract(r&#39;(\d+\.\d+)&#39;, expand=False))
</pre></div>
</div>
</div>
</div>
</section>
<section id="ajuste-de-los-targets-de-la-variable-type-storm-y-el-codigo-de-tormenta-code-storm">
<h2>ajuste de los targets de la variable Type_storm y el Codigo de tormenta (Code_storm)<a class="headerlink" href="#ajuste-de-los-targets-de-la-variable-type-storm-y-el-codigo-de-tormenta-code-storm" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cambia la columna &#39;nombre_columna&#39; a tipo string</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="c1"># Para asegurar que sea tipo String</span>

<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c1"># Asegurar que no haya espacios en los targets y todo sean en MAYUS</span>

<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Code_storm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Code_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Code_storm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Code_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ajuste-en-los-datos-de-fecha">
<h2>Ajuste en los datos de fecha<a class="headerlink" href="#ajuste-en-los-datos-de-fecha" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1">#Convertir la columna en Date en datetime</span>
<span class="c1">#hrc[&#39;Date&#39;] = pd.to_datetime(hrc[&#39;Date&#39;])</span>

<span class="c1"># Crear nuevas columnas para año, mes y día</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>

<span class="c1"># Eliminar la columna original &quot;Date&quot;</span>
<span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reorganizar las columnas: mover &#39;Año&#39;, &#39;Mes&#39; y &#39;Día&#39; a las posiciones 3, 4 y 5</span>
<span class="n">columnas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_procesado</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="c1"># Insertar las nuevas columnas en las posiciones deseadas</span>
<span class="n">columnas_nuevas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">columna</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columnas_nuevas</span><span class="p">):</span>
    <span class="n">columnas</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">columna</span><span class="p">)</span>  <span class="c1"># Eliminar la columna de su posición original</span>
    <span class="n">columnas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">columna</span><span class="p">)</span>  <span class="c1"># Insertar en la nueva posición (3, 4 y 5)</span>

<span class="c1"># Reordenar el DataFrame</span>
<span class="n">df_procesado</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="n">columnas</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conversión y separación de la hora y los minutos</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Hour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># Asegurar enteros</span>
<span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;Hour&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span>  <span class="c1"># División entera para las horas</span>
<span class="c1">#df_procesado[&#39;minuto&#39;] = df_procesado[&#39;Hour&#39;] % 100  # Resto para los minutos</span>

<span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Hour&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>Trackets</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>RecIdentifier</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>...</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Rad_Max_Wind</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>HU</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>HU</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>HU</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>12</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>HU</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.1</td>
      <td>96.5</td>
      <td>18</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>L</td>
      <td>HU</td>
      <td>80.0</td>
      <td>-999.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.2</td>
      <td>96.8</td>
      <td>21</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>54744</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>23</td>
      <td></td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>11.5</td>
      <td>83.2</td>
      <td>18</td>
    </tr>
    <tr>
      <th>54745</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>12.2</td>
      <td>83.4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>54746</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>L</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>12.4</td>
      <td>83.5</td>
      <td>1</td>
    </tr>
    <tr>
      <th>54747</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>13.0</td>
      <td>83.8</td>
      <td>6</td>
    </tr>
    <tr>
      <th>54748</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>LO</td>
      <td>20.0</td>
      <td>1007.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>13.5</td>
      <td>84.4</td>
      <td>12</td>
    </tr>
  </tbody>
</table>
<p>54749 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Hour&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Eliminar la columna Hour</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Move &#39;hora&#39; and &#39;minuto&#39; columns to positions 7 and 8</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_procesado</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">cols</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">)))</span>
<span class="c1">#cols.insert(8, cols.pop(cols.index(&#39;minuto&#39;)))</span>
<span class="n">df_procesado</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

<span class="n">df_procesado</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>Trackets</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>RecIdentifier</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>...</th>
      <th>SE50</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Rad_Max_Wind</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>0</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>94.8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>6</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>95.4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>12</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>96.0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_procesado</span><span class="p">[</span><span class="s1">&#39;fecha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">df_procesado</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_procesado</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>Trackets</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>RecIdentifier</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>...</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Rad_Max_Wind</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>0</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>6</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>12</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td></td>
      <td>18</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.1</td>
      <td>96.5</td>
      <td>1851-06-25 18:00:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>14</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>L</td>
      <td>21</td>
      <td>HU</td>
      <td>80.0</td>
      <td>...</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>-999.0</td>
      <td>28.2</td>
      <td>96.8</td>
      <td>1851-06-25 21:00:00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>54744</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>23</td>
      <td></td>
      <td>18</td>
      <td>TD</td>
      <td>25.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>11.5</td>
      <td>83.2</td>
      <td>2023-10-23 18:00:00</td>
    </tr>
    <tr>
      <th>54745</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>0</td>
      <td>TD</td>
      <td>25.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>12.2</td>
      <td>83.4</td>
      <td>2023-10-24 00:00:00</td>
    </tr>
    <tr>
      <th>54746</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>L</td>
      <td>1</td>
      <td>TD</td>
      <td>25.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>12.4</td>
      <td>83.5</td>
      <td>2023-10-24 01:00:00</td>
    </tr>
    <tr>
      <th>54747</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>6</td>
      <td>TD</td>
      <td>25.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>13.0</td>
      <td>83.8</td>
      <td>2023-10-24 06:00:00</td>
    </tr>
    <tr>
      <th>54748</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>6</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td></td>
      <td>12</td>
      <td>LO</td>
      <td>20.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>60.0</td>
      <td>13.5</td>
      <td>84.4</td>
      <td>2023-10-24 12:00:00</td>
    </tr>
  </tbody>
</table>
<p>54749 rows × 27 columns</p>
</div></div></div>
</div>
</section>
<section id="se-verifican-datos-duplicados-y-se-reemplaza-99-por-nan">
<h2>Se verifican datos duplicados y se reemplaza -99 por NaN<a class="headerlink" href="#se-verifican-datos-duplicados-y-se-reemplaza-99-por-nan" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">duplicados</span> <span class="o">=</span> <span class="n">df_procesado</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">duplicados</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reemplazar -999 por NaN en todo el DataFrame</span>
<span class="n">df_procesado</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_procesado</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="eliminacion-de-la-variable-rad-max-wind">
<h2>Eliminación de la variable Rad_Max_wind<a class="headerlink" href="#eliminacion-de-la-variable-rad-max-wind" title="Link to this heading">#</a></h2>
<p>Los valores de esta variable solo han sido rastreados de manera precisa a partir de 2021. Por ende, es la variable que cuenta con menor cantidad de datos, teniendo 1331 registros o filas, lo cual representa el 2.46% del set de datos total. Por este motivo, se decidió borrar esta variable del conjunto de datos.</p>
<p>Esta variable corresponde a los Radio de Vientos Máximos: Es la distancia desde el centro de un ciclón tropical hasta la ubicación de los vientos máximos del ciclón. En huracanes bien desarrollados, el radio de vientos máximos generalmente se encuentra en el borde interior de la pared del ojo (<a class="reference external" href="https://www.nhc.noaa.gov/aboutgloss.shtml#a">https://www.nhc.noaa.gov/aboutgloss.shtml#a</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Eliminar la columna &#39;Rad_Max_Wind&#39;</span>
<span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Rad_Max_Wind&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>RecIdentifier y Trackets son variables descriptivas asociadas a la toma de información, número de tracks registrados y …</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_procesado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RecIdentifier&#39;</span><span class="p">,</span> <span class="s1">&#39;Trackets&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ETL</span> <span class="o">=</span> <span class="n">df_procesado</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="eda-1">
<h1>EDA #1<a class="headerlink" href="#eda-1" title="Link to this heading">#</a></h1>
<section id="datos-faltantes">
<h2>Datos faltantes<a class="headerlink" href="#datos-faltantes" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ETL</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>NE34</th>
      <th>...</th>
      <th>SE50</th>
      <th>SW50</th>
      <th>NW50</th>
      <th>NE64</th>
      <th>SE64</th>
      <th>SW64</th>
      <th>NW64</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>0</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>6</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>12</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 24 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Procederemos a ver Missing values a través de msno.matrix</span>
<span class="kn">import</span> <span class="nn">missingno</span> <span class="k">as</span> <span class="nn">msno</span>
<span class="n">msno</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">df_ETL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ETL</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Code_storm        0
Name_storm        0
year              0
month             0
day               0
hour              0
type_storm        0
Max_wind         57
MinPress      30948
NE34          43802
SE34          43802
SW34          43802
NW34          43802
NE50          43802
SE50          43802
SW50          43802
NW50          43802
NE64          43802
SE64          43802
SW64          43802
NW64          43802
Lat_N             0
Lon_W             0
fecha             0
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Los datos faltantes corresponden a lo siguiente:</p>
<ul class="simple">
<li><p>“Minpress”, “solo se incluían valores si había una observación específica que pudiera utilizarse explicitamente”. A partir de 1979, se analizaba e incluía toda medición incluso si no fuese una medición in situ especifica.</p></li>
<li><p>NE34 to NW64: Estos valores están disponibles a partir de 2004 con una resolución de hasta 5 millas nauticas. Las columnas de NE34 a NW64 hace referencia al Wind Radii o <em>Radios de viento</em>. “Se refiere a la distancia desde el centro de un huracán hasta donde los vientos alcanzan ciertas velocidades específicas, medidas en diferentes cuadrantes (noreste, sureste, suroeste y noroeste). Se utilizan para describir el tamaño del huracán y la extensión de los vientos peligrosos en diferentes direcciones”. La distribución de los vientos alrededor de un huracán no es simétrica, entre mas lejos del ojo del huracán los vientos disminuyen y los vientos del lado derecho de la tormenta son mas fuertes en relación al lado izquierdo (De acuerdo a la dirección) (George &amp; Gray, 1976).<br />
<em>NOTA</em>:Si bien es cierto que se observaron patrones importantes y que coinciden con la literatura de que son características importantes en cada estado de tormenta, la realidad es que la medición y obtención de estos radios en tiempo real no es práctica lo que entorpece el funcionamiento de un modelo operativo en tiempo real, además dentro del set de datos de HURDAT2 solo se tienen datos desde el 2004 hasta el año presente, y aunque se exploró la estrategia de imputar datos, esta no fue finalmente realizada ni incluida en el trabajo, ya que la naturaleza de la variable se presta para un trabajo adicional enfocado solamente en los radios del viento de los huracanes, por ello, se recomienda tenerla en cuenta para futuros trabajos o incluso explorar la predicción de esta variable importante en los huracanes</p></li>
</ul>
<p>Gray, W. M., &amp; Shea, D. J. (1976). Data summary of NOAA’s hurricane inner-core radial leg flight penetrations 1957-1967, and 1969. Department of Atmospheric Sciences, Colorado State University.</p>
</section>
<section id="exploracion-de-los-radios-del-viento">
<h2>Exploración de los Radios del viento<a class="headerlink" href="#exploracion-de-los-radios-del-viento" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_negative_wind_radii</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

  <span class="n">negative_values</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;NW&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s1">&#39;NE&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s1">&#39;SE&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s1">&#39;SW&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
      <span class="n">negative_rows</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">negative_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">negative_values</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">negative_rows</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">negative_values</span>


<span class="n">negative_wind_radii</span> <span class="o">=</span> <span class="n">find_negative_wind_radii</span><span class="p">(</span><span class="n">df_ETL</span><span class="p">)</span>

<span class="k">if</span> <span class="n">negative_wind_radii</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores negativos en las columnas NW, NE, SE y SW y sus posiciones:&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">negative_wind_radii</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columna: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filas con valores negativos: </span><span class="si">{</span><span class="n">rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se encontraron valores negativos en las columnas NW, NE, SE y SW.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No se encontraron valores negativos en las columnas NW, NE, SE y SW.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">boxplots_windrad</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera gráficos de caja (boxplot) de NW, NE, SE y SW organizados en una cuadrícula de 3x3</span>
<span class="sd">    para cada tipo de tormenta en el dataframe, incluyendo los tres campos de viento (64, 50, 34).</span>
<span class="sd">    Los outliers tienen el mismo color que las cajas de cada campo de viento y no tienen borde negro.</span>

<span class="sd">    :param dataframe: DataFrame con los datos de tormentas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Definir colores personalizados para cada velocidad de viento</span>
    <span class="n">colores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;64&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;34&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">storm_type</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
            <span class="n">fig_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">fig_index</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">storm_type</span><span class="p">]</span>

        <span class="c1"># Transformar los datos usando melt</span>
        <span class="n">data_melted</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;NW64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;NE64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SE64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SW64&#39;</span><span class="p">,</span>
                                              <span class="sa">f</span><span class="s1">&#39;NW50&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;NE50&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SE50&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SW50&#39;</span><span class="p">,</span>
                                              <span class="sa">f</span><span class="s1">&#39;NW34&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;NE34&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SE34&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SW34&#39;</span><span class="p">],</span>
                                  <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Sector_Viento&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

        <span class="c1"># Extraer información de la columna Sector_Viento</span>
        <span class="n">data_melted</span><span class="p">[</span><span class="s1">&#39;Sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_melted</span><span class="p">[</span><span class="s1">&#39;Sector_Viento&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># NW, NE, SE, SW</span>
        <span class="n">data_melted</span><span class="p">[</span><span class="s1">&#39;Viento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_melted</span><span class="p">[</span><span class="s1">&#39;Sector_Viento&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># 64, 50, 34</span>

        <span class="c1"># Crear el boxplot con outliers personalizados</span>
        <span class="n">boxplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Sector&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Valor&#39;</span><span class="p">,</span>
            <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Viento&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data_melted</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">flierprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>  <span class="c1"># Configurar outliers</span>
        <span class="p">)</span>

        <span class="c1"># Personalizar los colores de outliers según su grupo de viento</span>
        <span class="k">for</span> <span class="n">artist</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxplot</span><span class="o">.</span><span class="n">artists</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colores</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colores</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">artist</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>  <span class="c1"># Color de la caja</span>
            <span class="n">artist</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>  <span class="c1"># Color del borde de la caja</span>

            <span class="c1"># Personalizar los outliers</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">boxplot</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;fliers&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">get_label</span><span class="p">():</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">set_markerfacecolor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>  <span class="c1"># Misma tonalidad de la caja</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">set_markeredgecolor</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># Sin borde negro</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Boxplot para </span><span class="si">{</span><span class="n">storm_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sector&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valores&#39;</span><span class="p">)</span>

        <span class="n">fig_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">fig_index</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">or</span> <span class="n">counter</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="n">sns</span><span class="o">.</span><span class="n">reset_defaults</span><span class="p">()</span>
<span class="n">boxplots_windrad</span><span class="p">(</span><span class="n">df_ETL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1f1a63987d3ae3185b06acac2b77a1d8efd638527a591134f23ea667d21276b7.png" src="_images/1f1a63987d3ae3185b06acac2b77a1d8efd638527a591134f23ea667d21276b7.png" />
<img alt="_images/d6a2a1770c09a7ae8ac6c05925567fc72cd042ee68e2ef0f076770fbc120a841.png" src="_images/d6a2a1770c09a7ae8ac6c05925567fc72cd042ee68e2ef0f076770fbc120a841.png" />
</div>
</div>
<p>Estas cajas de bigote muestran la distribución de los datos en cada cuadrante de la tormenta (NE, NW, SE, SW). Cada cuadrante puede presentar hasta 3 radios de vientos, en azul (64kt), naranja (50kt) y verde (34kt). Las gráficas de boxplot fueron realizadas para cada estado de la tormenta (WV, SD, SS, DB, LO, TD, EX, TS, HU)</p>
<ul class="simple">
<li><p>DB – Perturbación (de cualquier intensidad)</p></li>
<li><p>WV – Onda tropical (de cualquier intensidad)</p></li>
<li><p>LO – Baja no ciclónica (de cualquier intensidad)</p></li>
<li><p>TD – Depresión tropical (&lt; 34 nudos)</p></li>
<li><p>SD – Depresión subtropical (&lt; 34 nudos)</p></li>
<li><p>TS – Tormenta tropical (34-63 nudos)</p></li>
<li><p>SS – Tormenta subtropical (&gt; 34 nudos)</p></li>
<li><p>EX – Ciclón extratropical (de cualquier intensidad</p></li>
<li><p>HU – Huracán (&gt; 64 nudos)</p></li>
</ul>
<p>Se aprecian valores extremos en todas las cateegorias de Huracanes, además hay presencia de Radios del viento en LO, DB, y WV, lo cual puede parecer atípico en estos estados de tormenta, ya que son tormentas muy debiles como para tener una formación ciclonica y por ende radios de vientos, pero no son erroneos ya que un Huracan puede disminuir a un estado de tormenta muy debil como estos y de esta manera quedan remanentes de estos radios.</p>
<p>También, se puede observar que las bandas de 34, 50 y 64 nudos, se presentan especificamente en ciertas categorías de la tormenta, estando presente los 3 casos en la categoría de huracán (HU) y con la mayor distribución de valores (Km)</p>
<p>Se destaca también que la categoría Tormenta tropical (TS) registra valores de distancia para las bandas de 50 y 34 nudos solamente. Según (McKenzie, 2017) el radio del viento 64 está reservado para los ciclones tropicales con fuerza de huracán.</p>
<p>McKenzie III, T. B. (2017). A climatology of tropical cyclone size in the western North Pacific using an alternative metric (Master’s thesis, The Florida State University).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span> <span class="o">=</span> <span class="n">df_ETL</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NE34&#39;</span><span class="p">,</span> <span class="s1">&#39;SE34&#39;</span><span class="p">,</span> <span class="s1">&#39;SW34&#39;</span><span class="p">,</span> <span class="s1">&#39;NW34&#39;</span><span class="p">,</span> <span class="s1">&#39;NE50&#39;</span><span class="p">,</span> <span class="s1">&#39;SE50&#39;</span><span class="p">,</span> <span class="s1">&#39;SW50&#39;</span><span class="p">,</span> <span class="s1">&#39;NW50&#39;</span><span class="p">,</span> <span class="s1">&#39;NE64&#39;</span><span class="p">,</span> <span class="s1">&#39;SE64&#39;</span><span class="p">,</span> <span class="s1">&#39;SW64&#39;</span><span class="p">,</span> <span class="s1">&#39;NW64&#39;</span><span class="p">])</span>
<span class="n">df_EDA</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>0</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>6</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>12</td>
      <td>HU</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="agregar-categorias-de-huracan-type-storm-numerico">
<h2>Agregar Categorias de Huracan &amp; “type_storm” numérico<a class="headerlink" href="#agregar-categorias-de-huracan-type-storm-numerico" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>DB – Perturbación (de cualquier intensidad)</p></li>
<li><p>WV – Onda tropical (de cualquier intensidad)</p></li>
<li><p>LO – Baja no ciclónica (de cualquier intensidad)</p></li>
<li><p>TD – Depresión tropical (&lt; 34 nudos)</p></li>
<li><p>SD – Depresión subtropical (&lt; 34 nudos)</p></li>
<li><p>TS – Tormenta tropical (34-63 nudos)</p></li>
<li><p>SS – Tormenta subtropical (&gt; 34 nudos)</p></li>
<li><p>EX – Ciclón extratropical (de cualquier intensidad</p></li>
<li><p>HU – Huracán (&gt; 64 nudos)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clasificacion_huracan</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    64-82       Cat 1</span>
<span class="sd">    83-95       Cat 2</span>
<span class="sd">    96-113      Cat 3</span>
<span class="sd">    114-135     Cat 4</span>
<span class="sd">    Mayor 135 Cat 5</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">condiciones</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">82</span><span class="p">),</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">83</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">95</span><span class="p">),</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">96</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">113</span><span class="p">),</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">114</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">135</span><span class="p">),</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Max_wind&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">135</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">categorias</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cat 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Cat 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Cat 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Cat 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Cat 5&#39;</span><span class="p">]</span>

    <span class="c1"># Crear una nueva columna en el DataFrame con las categorías de huracanes</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;categoria_huracan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">condiciones</span><span class="p">,</span> <span class="n">categorias</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;Sin categoria&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span> <span class="o">=</span> <span class="n">clasificacion_huracan</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reemplazar &#39;HU&#39; en &#39;type_storm&#39; por el valor de &#39;categoria_huracan&#39; de la misma fila</span>
<span class="n">df_EDA</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HU&#39;</span><span class="p">,</span> <span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HU&#39;</span><span class="p">,</span> <span class="s1">&#39;categoria_huracan&#39;</span><span class="p">]</span>

<span class="n">df_EDA</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;categoria_huracan&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Las filas 25198 y 25199 presentaban categoría “HU” o sea Huracán. Sin embargo, la velocidad de viento máxima en estos dos registros fue de 60 nudos, lo cual está por debajo de los límites de la escala Saffir-Simpson que categoriza los estados Huracán de 1 a 5. Siendo 5 el mas fuerte.</p>
<p>Esto pudo deberse a un error al ingresar los datos por parte del NHC (Centro nacional de Huracanes de EE.UU) o que los vientos del viento de huracán se debilitaron pero se conservó el estado de la tormenta en “HU”.</p>
<p>En cualquier caso, se decide eliminar estas dos filas para no generar ruido en los modelos de clasificación.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">25198</span><span class="p">,</span> <span class="mi">25199</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>A continuación procedemos a convertir las categorias a númericas de manera manual, quiere decir, asignarle valores especificos para cada estado de tormenta.</p>
<p>Se usa el siguiente Mapeo, empezando el 1 con “TD” hasta 7 con “HU-Cat5” porque se usarán estas categorías para los modelos de clasificación de categorías.</p>
<p>Mientras que las restantes, se les coloca números restantes en orden, pero estas categorías no serán usadas para entrenar los modelos. Porque lo ideal es que la operatividad de los modelos empiece desde el estado de Depresión Tropical (TD). Además de simplificar el problema a menos categorías.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mapeo manual</span>
<span class="n">mapeo_target</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TD&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;TS&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Cat 1&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Cat 2&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Cat 3&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Cat 4&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Cat 5&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="s1">&#39;DB&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;WV&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;LO&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;SD&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;EX&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,}</span>

<span class="c1"># Aplicar el mapeo a la columna &#39;type_storm&#39;</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;type_storm_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapeo_target</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
      <th>type_storm_n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>0</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>6</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>12</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>18</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.1</td>
      <td>96.5</td>
      <td>1851-06-25 18:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>21</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>NaN</td>
      <td>28.2</td>
      <td>96.8</td>
      <td>1851-06-25 21:00:00</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="imputacion-de-presion-minima-minpress">
<h2>Imputación de Presión Mínima “Minpress”<a class="headerlink" href="#imputacion-de-presion-minima-minpress" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Eliminar filas con NaN</span>
<span class="n">hrc_press</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">press_clean</span> <span class="o">=</span> <span class="n">hrc_press</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">,</span> <span class="s1">&#39;type_storm&#39;</span><span class="p">])</span>

<span class="c1"># Gráficos de distribución por tipo de tormenta</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># 1. Histogramas por tipo de tormenta</span>
<span class="k">for</span> <span class="n">storm_type</span> <span class="ow">in</span> <span class="n">press_clean</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">press_clean</span><span class="p">[</span><span class="n">press_clean</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">storm_type</span><span class="p">][</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">storm_type</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de MinPress por Tipo de Tormenta&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;MinPress (mb)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># 2. Box plots</span>
<span class="n">press_clean</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;MinPress&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;type_storm&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Box Plot de MinPress por Tipo de Tormenta&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tipo de Tormenta&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MinPress (mb)&#39;</span><span class="p">)</span>

<span class="c1"># 3. Q-Q plots para normalidad</span>
<span class="n">storm_types</span> <span class="o">=</span> <span class="n">press_clean</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">storm_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">storm_types</span><span class="p">[:</span><span class="mi">4</span><span class="p">]):</span>  <span class="c1"># Solo primeros 4 tipos</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">press_clean</span><span class="p">[</span><span class="n">press_clean</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">storm_type</span><span class="p">][</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q-Q Plot - </span><span class="si">{</span><span class="n">storm_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 4. Test de Kolmogorov-Smirnov por tipo</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">storm_type</span> <span class="ow">in</span> <span class="n">storm_types</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">press_clean</span><span class="p">[</span><span class="n">press_clean</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">storm_type</span><span class="p">][</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="c1"># Normalizar los datos</span>
        <span class="n">data_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span><span class="n">data_norm</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Tipo&#39;</span><span class="p">:</span> <span class="n">storm_type</span><span class="p">,</span>
            <span class="s1">&#39;Estadístico&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="s1">&#39;p-valor&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;Normal&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
        <span class="p">})</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test de Kolmogorov-Smirnov por tipo de tormenta:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Gráfico de p-valores</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Tipo&#39;</span><span class="p">],</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;p-valor&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;α=0.05&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;P-valores del Test K-S&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tipo de Tormenta&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P-valor&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Resumen estadístico por tipo</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Estadísticas descriptivas por tipo de tormenta:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">press_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;type_storm&#39;</span><span class="p">)[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test de Kolmogorov-Smirnov por tipo de tormenta:
     Tipo  Estadístico       p-valor  Normal
0   Cat 3     0.064777  1.078040e-03   False
1   Cat 4     0.074709  7.057064e-04   False
2      TS     0.105658  1.278932e-79   False
3   Cat 2     0.083973  5.717901e-09   False
4   Cat 1     0.078087  2.428718e-18   False
5      EX     0.097321  2.375355e-21   False
6      TD     0.116633  6.662224e-47   False
7   Cat 5     0.090982  1.945478e-01    True
8      DB     0.102283  3.346421e-02   False
9      SS     0.081447  1.798898e-03   False
10     LO     0.150243  9.183964e-33   False
11     SD     0.087572  4.812734e-02   False
12     WV     0.147376  1.439014e-02   False
</pre></div>
</div>
<img alt="_images/2facc152b842c3ec18bb95183e8c93424aaf3385d487ffdfd0111e5f311e8a64.png" src="_images/2facc152b842c3ec18bb95183e8c93424aaf3385d487ffdfd0111e5f311e8a64.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estadísticas descriptivas por tipo de tormenta:
             count         mean        std     min     25%     50%     75%  \
type_storm                                                                   
Cat 1       3374.0   981.616183   8.958149   940.0   977.0   983.0   987.0   
Cat 2       1389.0   967.252700   8.639777   933.0   963.0   968.0   973.0   
Cat 3        891.0   954.445567   8.447067   920.0   950.0   955.0   960.0   
Cat 4        707.0   939.773692   9.209537   892.0   935.0   941.0   946.0   
Cat 5        137.0   918.116788  12.244486   882.0   911.0   920.0   926.0   
DB           192.0  1009.463542   3.783226   997.0  1007.0  1010.0  1013.0   
EX          2535.0   992.485602  14.530555   931.0   984.0   995.0  1004.0   
LO          1639.0  1008.758999   5.121110   954.0  1007.0  1009.0  1011.0   
SD           239.0  1007.861925   3.653273   996.0  1006.0  1008.0  1010.0   
SS           524.0   997.458015   7.712580   976.0   992.0   998.0  1004.0   
TD          3919.0  1007.450370   3.842486   982.0  1006.0  1008.0  1010.0   
TS          8144.0   999.243369   6.805518   959.0   995.0  1000.0  1004.0   
WV           111.0  1009.099099   1.838749  1005.0  1007.5  1009.0  1010.0   

               max  
type_storm          
Cat 1       1005.0  
Cat 2        998.0  
Cat 3        981.0  
Cat 4        964.0  
Cat 5        945.0  
DB          1016.0  
EX          1020.0  
LO          1024.0  
SD          1017.0  
SS          1014.0  
TD          1022.0  
TS          1016.0  
WV          1013.0  
</pre></div>
</div>
</div>
</div>
<p>Gráificos solo para Categoría 5</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtrar solo Cat 5 y eliminar NaN en MinPress</span>
<span class="n">cat5_minpress</span> <span class="o">=</span> <span class="n">hrc_press</span><span class="p">[(</span><span class="n">hrc_press</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cat 5&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">hrc_press</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>

<span class="c1"># Q-Q plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">cat5_minpress</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">],</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de MinPress para Cat 5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cuantiles teóricos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cuantiles de la muestra&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0e7c6dabd358ed467ee606c6395e975e027e797f54d899bf27dd5b06b4a86e82.png" src="_images/0e7c6dabd358ed467ee606c6395e975e027e797f54d899bf27dd5b06b4a86e82.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtrar solo Cat 5 y eliminar NaN en MinPress</span>
<span class="n">cat5_minpress</span> <span class="o">=</span> <span class="n">hrc_press</span><span class="p">[(</span><span class="n">hrc_press</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cat 5&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">hrc_press</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>

<span class="c1"># Histograma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cat5_minpress</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histograma de MinPress para Cat 5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;MinPress (mb)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/936534177bd50f5c708dc89a555647c2c1005b81dc56de2113d8293f8797c9fb.png" src="_images/936534177bd50f5c708dc89a555647c2c1005b81dc56de2113d8293f8797c9fb.png" />
</div>
</div>
<p>Sabiendo entonces que la distribución de los datos de MinPress no sigue una distribucion en normal en niguna de las categorias. Procedemos a usar la MEDIANA de cada categoria para imputar en los valores faltantes de MinPress.</p>
<p>La categoria 5, sigue una distribución normal según el valor P del test K-S</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ver valores faltantes antes de imputar</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores faltantes antes de imputar:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># Diccionario con las medianas por tipo de tormenta</span>
<span class="n">medianas_por_tipo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Cat 1&#39;</span><span class="p">:</span> <span class="mf">983.0</span><span class="p">,</span>
    <span class="s1">&#39;Cat 2&#39;</span><span class="p">:</span> <span class="mf">968.0</span><span class="p">,</span>
    <span class="s1">&#39;Cat 3&#39;</span><span class="p">:</span> <span class="mf">955.0</span><span class="p">,</span>
    <span class="s1">&#39;Cat 4&#39;</span><span class="p">:</span> <span class="mf">941.0</span><span class="p">,</span>
    <span class="s1">&#39;Cat 5&#39;</span><span class="p">:</span> <span class="mf">918.1</span><span class="p">,</span> <span class="c1"># Para esta categoria se usa el promedio y no la mediana.</span>
    <span class="s1">&#39;DB&#39;</span><span class="p">:</span> <span class="mf">1010.0</span><span class="p">,</span>
    <span class="s1">&#39;EX&#39;</span><span class="p">:</span> <span class="mf">995.0</span><span class="p">,</span>
    <span class="s1">&#39;LO&#39;</span><span class="p">:</span> <span class="mf">1009.0</span><span class="p">,</span>
    <span class="s1">&#39;SD&#39;</span><span class="p">:</span> <span class="mf">1008.0</span><span class="p">,</span>
    <span class="s1">&#39;SS&#39;</span><span class="p">:</span> <span class="mf">998.0</span><span class="p">,</span>
    <span class="s1">&#39;TD&#39;</span><span class="p">:</span> <span class="mf">1008.0</span><span class="p">,</span>
    <span class="s1">&#39;TS&#39;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span>
    <span class="s1">&#39;WV&#39;</span><span class="p">:</span> <span class="mf">1009.0</span>
<span class="p">}</span>

<span class="c1"># Imputar directamente en la variable MinPress</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">medianas_por_tipo</span><span class="p">))</span>

<span class="c1"># Verificar valores faltantes después de imputar</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valores faltantes después de imputar: </span><span class="si">{</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar filas que aún tienen valores faltantes</span>
<span class="n">filas_con_nan</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filas que quedaron con valores faltantes después de imputar:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total de filas con NaN: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filas_con_nan</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filas_con_nan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detalle de las filas con valores faltantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filas_con_nan</span><span class="p">[[</span><span class="s1">&#39;type_storm&#39;</span><span class="p">,</span> <span class="s1">&#39;MinPress&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No quedaron valores faltantes después de la imputación.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Valores faltantes antes de imputar:
30946

Valores faltantes después de imputar: 0

Filas que quedaron con valores faltantes después de imputar:
Total de filas con NaN: 0
No quedaron valores faltantes después de la imputación.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
      <th>type_storm_n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>0</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>6</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>12</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msno</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/99698b842251e5763d66999150e4c3e521864fe2b43bf7f7f73160883cbef825.png" src="_images/99698b842251e5763d66999150e4c3e521864fe2b43bf7f7f73160883cbef825.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="imputaciones">
<h1>IMPUTACIONES<a class="headerlink" href="#imputaciones" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>Lat_N</th>
      <th>Lon_W</th>
      <th>fecha</th>
      <th>type_storm_n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>0</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>94.8</td>
      <td>1851-06-25 00:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>6</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>95.4</td>
      <td>1851-06-25 06:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>12</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.0</td>
      <td>96.0</td>
      <td>1851-06-25 12:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>18</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.1</td>
      <td>96.5</td>
      <td>1851-06-25 18:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>21</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.2</td>
      <td>96.8</td>
      <td>1851-06-25 21:00:00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>54744</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>23</td>
      <td>18</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>11.5</td>
      <td>83.2</td>
      <td>2023-10-23 18:00:00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>54745</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>0</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>12.2</td>
      <td>83.4</td>
      <td>2023-10-24 00:00:00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>54746</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>1</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>12.4</td>
      <td>83.5</td>
      <td>2023-10-24 01:00:00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>54747</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>6</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>13.0</td>
      <td>83.8</td>
      <td>2023-10-24 06:00:00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>54748</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>12</td>
      <td>LO</td>
      <td>20.0</td>
      <td>1007.0</td>
      <td>13.5</td>
      <td>84.4</td>
      <td>2023-10-24 12:00:00</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
<p>54747 rows × 13 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Lon_W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Lon_W&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="calculo-de-vector-de-longitud">
<h2>Cálculo de vector de longitud<a class="headerlink" href="#calculo-de-vector-de-longitud" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear columnas para vectores</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Diccionario para almacenar vectores</span>
<span class="n">vecs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vec_x&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;vec_y&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="c1"># Procesar cada tormenta por separado</span>
<span class="k">for</span> <span class="n">storm_id</span> <span class="ow">in</span> <span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># Filtrar datos de la tormenta y ordenar por fecha</span>
    <span class="n">storm_data</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">storm_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">storm_data</span> <span class="o">=</span> <span class="n">storm_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Inicializar variables</span>
    <span class="n">last_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_y</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Calcular vectores para cada punto de la tormenta</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">storm_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">current_x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Lon_W&quot;</span><span class="p">]</span>
        <span class="n">current_y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Lat_N&quot;</span><span class="p">]</span>
        
        <span class="c1"># Si no es el primer punto, calcular vector</span>
        <span class="k">if</span> <span class="n">last_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vec_x</span> <span class="o">=</span> <span class="n">current_x</span> <span class="o">-</span> <span class="n">last_x</span>
            <span class="n">vec_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">last_y</span>
            
            <span class="c1"># Guardar vector y índice original</span>
            <span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;vec_x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec_x</span><span class="p">)</span>
            <span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;vec_y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec_y</span><span class="p">)</span>
            <span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>  <span class="c1"># Índice original en df</span>
        
        <span class="c1"># Actualizar coordenadas para siguiente iteración</span>
        <span class="n">last_x</span> <span class="o">=</span> <span class="n">current_x</span>
        <span class="n">last_y</span> <span class="o">=</span> <span class="n">current_y</span>

<span class="c1"># Asignar vectores al DataFrame original</span>
<span class="n">df_EDA</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;vec_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;vec_x&quot;</span><span class="p">]</span>
<span class="n">df_EDA</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;vec_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[</span><span class="s2">&quot;vec_y&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Manejado la ecuación de calculo de un vector a partir de grados decimales.</p>
<ul class="simple">
<li><p>Vector_Longitud = ((vec_x)”2 + (vec_y)”2)”-2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_x&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_y&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Hubo valores de 354 a 356 de vec_len que no permitía graficar un buen histograma, así que eliminamos la ficha que corresponde a ese valor de 356. Sucedió porque se registró una tormenta en dos punto muy distantes y en las etapas finales de la tormenta cuando sale de la zona de los trópicos y gana mas velocidad</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ver cuántos se eliminarán</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filas a eliminar: </span><span class="si">{</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;vec_len&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">354</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Eliminar</span>
<span class="n">df_EDA</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_len&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">354</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filas a eliminar: 4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histograma de valores mayores a 5.5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s1">&#39;vec_len&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de Valores en vec_len&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Valores de vec_len&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25c232fc6da046bc297ea1fbeda09d4330b76d53910ec3455e85cf696cb4af7e.png" src="_images/25c232fc6da046bc297ea1fbeda09d4330b76d53910ec3455e85cf696cb4af7e.png" />
</div>
</div>
</section>
<section id="calculo-de-la-direccion-de-la-tormenta">
<h2>Calculo de la dirección de la tormenta<a class="headerlink" href="#calculo-de-la-direccion-de-la-tormenta" title="Link to this heading">#</a></h2>
<p>La ecuación usada para el cálculo de la dirección es:</p>
<ul class="simple">
<li><p>Dirección = Arctg( vector_x / vector_y)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_direction</span><span class="p">(</span><span class="n">vec_x</span><span class="p">,</span> <span class="n">vec_y</span><span class="p">):</span>
    <span class="c1"># atan2 devuelve el ángulo en radianes en el rango [-π, π]</span>
    <span class="c1"># (x, y) para que 0 rad apunte al norte</span>
    <span class="c1">#return np.arctan2(vec_y, -vec_x)</span>
    
    <span class="c1"># (x, y) para que 0 rad apunte al este</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vec_x</span><span class="p">,</span> <span class="n">vec_y</span><span class="p">)</span>


<span class="c1"># Aplicar al DataFrame</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">calculate_direction</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">vec_x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">vec_y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/509707704.py:11: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[&quot;vec_direction&quot;] = df_EDA.apply(lambda x: calculate_direction(x.vec_x, x.vec_y), axis=1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histograma de vec_direction</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;vec_direction&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribución de vec_direction&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;vec_direction (radianes)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frecuencia&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6ed1fb3223ca00dd54aa1f41a7653d91af1036cf0211ccb0a821c073f7e91ea1.png" src="_images/6ed1fb3223ca00dd54aa1f41a7653d91af1036cf0211ccb0a821c073f7e91ea1.png" />
</div>
</div>
<p>Para cada tormenta (Code_storm) vamos a crear 3 lags, quiere decir, los 3 pasos anteriores</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Para cada tormenta (Code_storm) vamos a crear 3 columnas con desplazamiento</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">df_EDA</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prev_len_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">)[</span><span class="s2">&quot;vec_len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">df_EDA</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prev_direction_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">)[</span><span class="s2">&quot;vec_direction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_len_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_len&quot;].shift(k)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_direction_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_direction&quot;].shift(k)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_len_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_len&quot;].shift(k)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_direction_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_direction&quot;].shift(k)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_len_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_len&quot;].shift(k)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/3036120763.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[f&quot;prev_direction_{k}&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_direction&quot;].shift(k)
</pre></div>
</div>
</div>
</div>
<p>Se crea una columna que almacenará un paso adelante del vector longitud y vector dirección. Llevará el nombre next_len y next_dir y serán los targets en cada modelo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;next_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">)[</span><span class="s2">&quot;vec_len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;next_direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">)[</span><span class="s2">&quot;vec_direction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/449305890.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[&quot;next_len&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_len&quot;].shift(-1)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/449305890.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_EDA[&quot;next_direction&quot;] = df_EDA.groupby(&quot;Code_storm&quot;)[&quot;vec_direction&quot;].shift(-1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finalmente Se eliminan todas las filas que tengan valores nulos, ya que no se puede usar para entrenar los modelos</span>
<span class="n">df_EDA</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_EDA</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Code_storm</th>
      <th>Name_storm</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>type_storm</th>
      <th>Max_wind</th>
      <th>MinPress</th>
      <th>Lat_N</th>
      <th>...</th>
      <th>vec_len</th>
      <th>vec_direction</th>
      <th>prev_len_1</th>
      <th>prev_direction_1</th>
      <th>prev_len_2</th>
      <th>prev_direction_2</th>
      <th>prev_len_3</th>
      <th>prev_direction_3</th>
      <th>next_len</th>
      <th>next_direction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>25</td>
      <td>21</td>
      <td>Cat 1</td>
      <td>80.0</td>
      <td>983.0</td>
      <td>28.2</td>
      <td>...</td>
      <td>0.316228</td>
      <td>-1.249046</td>
      <td>0.509902</td>
      <td>-1.373401</td>
      <td>0.600000</td>
      <td>-1.570796</td>
      <td>0.600000</td>
      <td>-1.570796</td>
      <td>0.200000</td>
      <td>-1.570796</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>26</td>
      <td>0</td>
      <td>Cat 1</td>
      <td>70.0</td>
      <td>983.0</td>
      <td>28.2</td>
      <td>...</td>
      <td>0.200000</td>
      <td>-1.570796</td>
      <td>0.316228</td>
      <td>-1.249046</td>
      <td>0.509902</td>
      <td>-1.373401</td>
      <td>0.600000</td>
      <td>-1.570796</td>
      <td>0.608276</td>
      <td>-1.405648</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>26</td>
      <td>6</td>
      <td>TS</td>
      <td>60.0</td>
      <td>1000.0</td>
      <td>28.3</td>
      <td>...</td>
      <td>0.608276</td>
      <td>-1.405648</td>
      <td>0.200000</td>
      <td>-1.570796</td>
      <td>0.316228</td>
      <td>-1.249046</td>
      <td>0.509902</td>
      <td>-1.373401</td>
      <td>0.707107</td>
      <td>-1.428899</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>26</td>
      <td>12</td>
      <td>TS</td>
      <td>60.0</td>
      <td>1000.0</td>
      <td>28.4</td>
      <td>...</td>
      <td>0.707107</td>
      <td>-1.428899</td>
      <td>0.608276</td>
      <td>-1.405648</td>
      <td>0.200000</td>
      <td>-1.570796</td>
      <td>0.316228</td>
      <td>-1.249046</td>
      <td>0.632456</td>
      <td>-1.249046</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AL011851</td>
      <td>UNNAMED</td>
      <td>1851</td>
      <td>6</td>
      <td>26</td>
      <td>18</td>
      <td>TS</td>
      <td>50.0</td>
      <td>1000.0</td>
      <td>28.6</td>
      <td>...</td>
      <td>0.632456</td>
      <td>-1.249046</td>
      <td>0.707107</td>
      <td>-1.428899</td>
      <td>0.608276</td>
      <td>-1.405648</td>
      <td>0.200000</td>
      <td>-1.570796</td>
      <td>0.640312</td>
      <td>-0.896055</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>45008</th>
      <td>AL202023</td>
      <td>TAMMY</td>
      <td>2023</td>
      <td>10</td>
      <td>30</td>
      <td>18</td>
      <td>LO</td>
      <td>25.0</td>
      <td>1006.0</td>
      <td>26.5</td>
      <td>...</td>
      <td>1.077033</td>
      <td>2.761086</td>
      <td>1.118034</td>
      <td>2.677945</td>
      <td>1.252996</td>
      <td>2.642246</td>
      <td>1.838478</td>
      <td>2.356194</td>
      <td>0.984886</td>
      <td>-2.723368</td>
    </tr>
    <tr>
      <th>45009</th>
      <td>AL202023</td>
      <td>TAMMY</td>
      <td>2023</td>
      <td>10</td>
      <td>31</td>
      <td>0</td>
      <td>LO</td>
      <td>25.0</td>
      <td>1006.0</td>
      <td>25.6</td>
      <td>...</td>
      <td>0.984886</td>
      <td>-2.723368</td>
      <td>1.077033</td>
      <td>2.761086</td>
      <td>1.118034</td>
      <td>2.677945</td>
      <td>1.252996</td>
      <td>2.642246</td>
      <td>0.707107</td>
      <td>-2.356194</td>
    </tr>
    <tr>
      <th>45010</th>
      <td>AL202023</td>
      <td>TAMMY</td>
      <td>2023</td>
      <td>10</td>
      <td>31</td>
      <td>6</td>
      <td>LO</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>25.1</td>
      <td>...</td>
      <td>0.707107</td>
      <td>-2.356194</td>
      <td>0.984886</td>
      <td>-2.723368</td>
      <td>1.077033</td>
      <td>2.761086</td>
      <td>1.118034</td>
      <td>2.677945</td>
      <td>0.921954</td>
      <td>-1.789465</td>
    </tr>
    <tr>
      <th>45011</th>
      <td>AL202023</td>
      <td>TAMMY</td>
      <td>2023</td>
      <td>10</td>
      <td>31</td>
      <td>12</td>
      <td>LO</td>
      <td>20.0</td>
      <td>1008.0</td>
      <td>24.9</td>
      <td>...</td>
      <td>0.921954</td>
      <td>-1.789465</td>
      <td>0.707107</td>
      <td>-2.356194</td>
      <td>0.984886</td>
      <td>-2.723368</td>
      <td>1.077033</td>
      <td>2.761086</td>
      <td>0.761577</td>
      <td>-1.975688</td>
    </tr>
    <tr>
      <th>45012</th>
      <td>AL212023</td>
      <td>TWENTY-ONE</td>
      <td>2023</td>
      <td>10</td>
      <td>24</td>
      <td>6</td>
      <td>TD</td>
      <td>25.0</td>
      <td>1007.0</td>
      <td>13.0</td>
      <td>...</td>
      <td>0.670820</td>
      <td>-0.463648</td>
      <td>0.223607</td>
      <td>-0.463648</td>
      <td>0.728011</td>
      <td>-0.278300</td>
      <td>0.608276</td>
      <td>-1.405648</td>
      <td>0.781025</td>
      <td>-0.876058</td>
    </tr>
  </tbody>
</table>
<p>45013 rows × 25 columns</p>
</div></div></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="generico-pruebas">
<h1>Generico pruebas<a class="headerlink" href="#generico-pruebas" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Imports y setup general ---</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span> <span class="k">as</span> <span class="n">_mse</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">SEED</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

<span class="c1"># --- Métricas (RMSE compatible con versiones viejas de sklearn) ---</span>
<span class="k">def</span> <span class="nf">RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_mse</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># sklearn moderno</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_mse</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">yp</span><span class="p">))</span>        <span class="c1"># sklearn antiguo</span>

<span class="k">def</span> <span class="nf">MAE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sMAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="p">,</span> <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_loader</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">X_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_t</span><span class="p">,</span> <span class="n">y_t</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =========================</span>
<span class="c1"># HELPERS COMUNES (pegar una vez)</span>
<span class="c1"># =========================</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;#333&quot;</span><span class="p">,</span><span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span><span class="s2">&quot;legend.frameon&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

<span class="n">COL_REAL</span><span class="p">,</span> <span class="n">COL_PRED</span><span class="p">,</span> <span class="n">COL_ERR</span> <span class="o">=</span> <span class="s2">&quot;#e76f51&quot;</span><span class="p">,</span> <span class="s2">&quot;#b08d57&quot;</span><span class="p">,</span> <span class="s2">&quot;#9aa0a6&quot;</span>
<span class="n">H_GRAPH</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># horizonte a graficar (0 = t+1)</span>

<span class="c1"># Métricas</span>
<span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())))</span>
<span class="k">def</span> <span class="nf">MAE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">sMAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>

<span class="c1"># Fechas por bloque</span>
<span class="k">def</span> <span class="nf">last_block_dates</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]);</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">;</span> <span class="n">start</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># BDS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">bds</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">False</span>
<span class="k">def</span> <span class="nf">run_bds</span><span class="p">(</span><span class="n">residuals_1d</span><span class="p">,</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BDS</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;BDS no disponible.&quot;</span>
    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">residuals_1d</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">stats_b</span><span class="p">,</span><span class="n">pvals</span><span class="o">=</span><span class="n">bds</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">max_dim</span><span class="o">=</span><span class="n">max_dim</span><span class="p">)</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">stats_b</span><span class="p">)))</span>
    <span class="n">lines</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">: p=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">))]</span>
    <span class="n">concl</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Rechazamos H0 — residuos NO independientes.&quot;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span>
           <span class="s2">&quot;No rechazamos H0 — residuos independientes.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; || &quot;</span><span class="o">+</span><span class="n">concl</span>

<span class="c1"># Importancias (árboles/XGB; lineales por |coef|; sino, ceros)</span>
<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>
<span class="k">def</span> <span class="nf">get_importances</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_feats</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;feature_importances_&quot;</span><span class="p">):</span>
        <span class="n">imp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imp</span> <span class="k">if</span> <span class="n">imp</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n_feats</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span><span class="n">n_feats</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;coef_&quot;</span><span class="p">):</span>
        <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n_feats</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n_feats</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">MultiOutputRegressor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s2">&quot;estimators_&quot;</span><span class="p">):</span>
        <span class="n">imps</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="s2">&quot;feature_importances_&quot;</span><span class="p">):</span>
                <span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">imps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n_feats</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n_feats</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="s2">&quot;coef_&quot;</span><span class="p">):</span>
                <span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">imps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n_feats</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n_feats</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">imps</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Plot </span>
<span class="k">def</span> <span class="nf">plot_like_partner</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span>
                      <span class="n">y_tr_pred</span><span class="p">,</span> <span class="n">y_cv_pred</span><span class="p">,</span> <span class="n">y_te_pred</span><span class="p">,</span> <span class="n">importances_vec</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">Nte</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Ntr</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ytest</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ycv</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">test_dates</span>  <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nte</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">val_dates</span>   <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="p">)</span>
    <span class="n">train_dates</span> <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Ntr</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="o">+</span><span class="n">Nva</span><span class="p">)</span>

    <span class="n">resid_h0</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># General 3x3</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span> <span class="n">gs</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Valores Reales (Test)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicciones (Test)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicciones vs Valores Reales - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> (TEST)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
    <span class="n">miv</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">mav</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],[</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea perfecta&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dispersión: Real vs Predicho (TEST)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Valores Reales&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicciones&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">resid_h0</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuos del Modelo (TEST)&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">)</span>

    <span class="n">ax4</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Residuos (TEST)&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>

    <span class="n">ax5</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">top</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">importances_vec</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:];</span> <span class="n">fi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feat_names</span><span class="p">)[</span><span class="n">top</span><span class="p">],</span><span class="s2">&quot;importance&quot;</span><span class="p">:</span><span class="n">importances_vec</span><span class="p">[</span><span class="n">top</span><span class="p">]})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)),</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)));</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importancia&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 10 Features Importantes&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">ax6</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mape_val</span><span class="o">=</span><span class="n">MAPE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">mae_val</span><span class="o">=</span><span class="n">MAE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">rmse_val</span><span class="o">=</span><span class="n">RMSE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">)</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([[</span><span class="n">mape_val</span><span class="p">],[</span><span class="n">mae_val</span><span class="p">],[</span><span class="n">rmse_val</span><span class="p">]],</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">,</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Métricas CV (Validación)&#39;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

    <span class="n">ax7</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">ax7</span><span class="p">)</span>
    <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de Residuos (TEST)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Análisis General - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> - Series Temporales&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Por conjunto</span>
    <span class="n">fig2</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Train)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Train)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TRAIN - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Val)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Val)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto VALIDATION - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Test)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Test - final_model)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TEST - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Entrena/valida/test para modelos scikit-learn</span>
<span class="k">def</span> <span class="nf">fit_eval_plot_sklearn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="c1"># Train -&gt; Val</span>
    <span class="n">mdl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s2">&quot;get_params&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_tr</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">y_va</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>

    <span class="c1"># Train+Val -&gt; Test</span>
    <span class="n">mdl_f</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s2">&quot;get_params&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
    <span class="n">mdl_f</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]))</span>
    <span class="n">y_te</span> <span class="o">=</span> <span class="n">mdl_f</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>

    <span class="c1"># Métricas</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">] Métricas&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_va</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># BDS h=0</span>
    <span class="n">resid_h0</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">))</span>

    <span class="c1"># Importancias</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">get_importances</span><span class="p">(</span><span class="n">mdl_f</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Plots</span>
    <span class="n">plot_like_partner</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span><span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span><span class="n">y_va</span><span class="p">,</span><span class="n">y_te</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="split">
<h1>Split<a class="headerlink" href="#split" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tsxv.splitTrainValTest</span> <span class="kn">import</span> <span class="n">split_train_val_test_groupKFold</span>

<span class="n">LOOKBACK</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HORIZON</span>  <span class="o">=</span> <span class="mi">7</span>
<span class="n">JUMP</span>     <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># 1. PRIMERO: Dividir tormentas entre train y test</span>
<span class="n">cantidad_unicos</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cantidad_unicos</span> <span class="o">*</span> <span class="mf">0.10</span><span class="p">)</span>  <span class="c1"># 10% para test</span>

<span class="n">storm_test_ids</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="n">n_test</span><span class="p">]</span>

<span class="n">test_df</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">storm_test_ids</span><span class="p">)]</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">df_EDA</span><span class="p">[</span><span class="o">~</span><span class="n">df_EDA</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">storm_test_ids</span><span class="p">)]</span>

<span class="c1"># 2. Guardar los grupos solo del conjunto de entrenamiento</span>
<span class="n">grupos</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Code_storm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># 3. AHORA SÍ: Aplicar split_train_val_test_groupKFold SOLO sobre train_df</span>
<span class="n">X_features</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[[</span><span class="s1">&#39;MinPress&#39;</span><span class="p">,</span> <span class="s1">&#39;Max_wind&#39;</span><span class="p">,</span> <span class="s1">&#39;vec_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;vec_len&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">y_target</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[[</span><span class="s1">&#39;next_direction&#39;</span><span class="p">,</span><span class="s1">&#39;next_len&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">res_X</span> <span class="o">=</span> <span class="n">split_train_val_test_groupKFold</span><span class="p">(</span>
    <span class="n">sequence</span><span class="o">=</span><span class="n">X_features</span><span class="p">,</span>
    <span class="n">numInputs</span><span class="o">=</span><span class="n">LOOKBACK</span><span class="p">,</span>
    <span class="n">numOutputs</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span>
    <span class="n">numJumps</span><span class="o">=</span><span class="n">JUMP</span>
<span class="p">)</span>

<span class="n">res_y</span> <span class="o">=</span> <span class="n">split_train_val_test_groupKFold</span><span class="p">(</span>
    <span class="n">sequence</span><span class="o">=</span><span class="n">y_target</span><span class="p">,</span>
    <span class="n">numInputs</span><span class="o">=</span><span class="n">LOOKBACK</span><span class="p">,</span>
    <span class="n">numOutputs</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span>
    <span class="n">numJumps</span><span class="o">=</span><span class="n">JUMP</span>
<span class="p">)</span>

<span class="c1"># ... resto igual</span>
<span class="c1"># --- Desempaquetador robusto (tupla con dicts o 6 arrays) ---</span>
<span class="k">def</span> <span class="nf">unpack_timeseries_cv</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dicts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Xd</span><span class="p">,</span> <span class="n">Yd</span> <span class="o">=</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">common</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Xd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">Yd</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No hay suficientes subconjuntos: </span><span class="si">{</span><span class="n">common</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">k_tr</span><span class="p">,</span> <span class="n">k_val</span><span class="p">,</span> <span class="n">k_te</span> <span class="o">=</span> <span class="n">common</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Xd</span><span class="p">[</span><span class="n">k_tr</span><span class="p">],</span> <span class="n">Yd</span><span class="p">[</span><span class="n">k_tr</span><span class="p">],</span> <span class="n">Xd</span><span class="p">[</span><span class="n">k_val</span><span class="p">],</span> <span class="n">Yd</span><span class="p">[</span><span class="n">k_val</span><span class="p">],</span> <span class="n">Xd</span><span class="p">[</span><span class="n">k_te</span><span class="p">],</span> <span class="n">Yd</span><span class="p">[</span><span class="n">k_te</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">res</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dicts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">lookback</span><span class="p">]</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">horizon</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Xs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Xs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">,</span><span class="s1">&#39;ytrain&#39;</span><span class="p">,</span><span class="s1">&#39;Xval&#39;</span><span class="p">,</span><span class="s1">&#39;yval&#39;</span><span class="p">,</span><span class="s1">&#39;Xtest&#39;</span><span class="p">,</span><span class="s1">&#39;ytest&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;ytrain&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Xval&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;yval&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Xtest&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;ytest&#39;</span><span class="p">]</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Formato inesperado: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Desempaquetar</span>
<span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unpack_timeseries_cv</span><span class="p">(</span><span class="n">res_X</span><span class="p">,</span> <span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ytest</span> <span class="o">=</span> <span class="n">unpack_timeseries_cv</span><span class="p">(</span><span class="n">res_y</span><span class="p">,</span> <span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">)</span>

<span class="c1"># Ahora X tiene shape (n_samples, LOOKBACK, 3) - necesitas aplanarlo para ML clásico</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (n_samples, LOOKBACK*3) = (n_samples, 600)</span>
<span class="n">Xcv</span> <span class="o">=</span> <span class="n">Xcv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xcv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xtest</span> <span class="o">=</span> <span class="n">Xtest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train:&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># X: (n, 600), y: (n, 7)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Val:  &quot;</span><span class="p">,</span> <span class="n">Xcv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ycv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test: &quot;</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ytest</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># --- DataLoaders ---</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">make_loader</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_loader</span>   <span class="o">=</span> <span class="n">make_loader</span><span class="p">(</span><span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_loader</span>  <span class="o">=</span> <span class="n">make_loader</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Sanity: el batch debe ser [B,14] y [B,7] (no [B,14,1])</span>
<span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch sample:&quot;</span><span class="p">,</span> <span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">yb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># esperado: (*,14) (*,7)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train: (208, 1000) (208, 7, 2)
Val:   (207, 1000) (207, 7, 2)
Test:  (206, 1000) (206, 7, 2)
Batch sample: torch.Size([208, 1000]) torch.Size([208, 7, 2])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Paso 3) Crear splits con timeseries-cv (tu API real)</span>
<span class="c1"># - Usamos split_train_val_test_groupKFold con:</span>
<span class="c1">#       numInputs=200  (LOOKBACK: 14 días pasados como entrada)</span>
<span class="c1">#       numOutputs=7  (HORIZON: 7 días futuros como etiqueta)</span>
<span class="c1">#       numJumps=4    (JUMP: la ventana se desliza día a día)</span>
<span class="c1"># - Se devuelve una tupla con diccionarios; por eso desempaquetamos de forma robusta</span>
<span class="c1">#   hasta obtener:</span>
<span class="c1">#       X, y     -&gt; Train   (shapes ~ (796,200), (796,7))</span>
<span class="c1">#       Xcv, ycv -&gt; Val     (shapes ~ (795,200), (795,7))</span>
<span class="c1">#       Xtest, ytest -&gt; Test (shapes ~ (794,200), (794,7))</span>
<span class="c1">#   -&gt; Esto convierte la serie en un dataset supervisado: cada fila de X son 200 días, y, Y es el</span>
<span class="c1">#      vector de 7 días siguientes.</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-knn">
<h1>Modelo KNN<a class="headerlink" href="#modelo-knn" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="c1"># KNN soporta multi-output directamente</span>
<span class="c1"># Aplanar X de (n_samples, lookback, n_features) a (n_samples, lookback*n_features)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xcv</span> <span class="o">=</span> <span class="n">Xcv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xcv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xtest</span> <span class="o">=</span> <span class="n">Xtest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Aplanar y de (n_samples, horizon, n_outputs) a (n_samples, horizon*n_outputs)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ycv</span> <span class="o">=</span> <span class="n">ycv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ytest</span> <span class="o">=</span> <span class="n">ytest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ytest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Entrenar KNN</span>
<span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;minkowski&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fit_eval_plot_sklearn</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="s2">&quot;KNN&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[KNN] Métricas
Train: MAPE=61.6277% | MAE=0.000001 | RMSE=0.000004
  Val: MAPE=23072942.2392% | MAE=0.196383 | RMSE=0.552011 | sMAPE=23.04%
 Test: MAPE=39938595.3365% | MAE=0.169211 | RMSE=0.535271 | sMAPE=19.10%
[KNN] BDS (residuos TEST, h=t+1): m=2: p=0.0242 | m=3: p=0.00177 | m=4: p=0.00835 | m=5: p=0.0194 | m=6: p=0.0166 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:123: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:130: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/ac3d53e6c368d66fbe8b84e557547c797287fe9f45f838e893e7eb50a226ea0a.png" src="_images/ac3d53e6c368d66fbe8b84e557547c797287fe9f45f838e893e7eb50a226ea0a.png" />
<img alt="_images/a60146ff7a6c9e6bba1eb5169ee1fa327bda4e0327f9accf858e19c8beec4cc5.png" src="_images/a60146ff7a6c9e6bba1eb5169ee1fa327bda4e0327f9accf858e19c8beec4cc5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Entrenar el modelo knn con todos los datos (train + validation)</span>
<span class="n">X_train_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">])</span>
<span class="n">y_train_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">ycv</span><span class="p">])</span>

<span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">)</span>

<span class="c1">#guardar el modelo</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="s1">&#39;./models_all/knn_model.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;./models_all/knn_model.pkl&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-decission-tree">
<h1>Modelo Decission tree<a class="headerlink" href="#modelo-decission-tree" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================</span>
<span class="c1"># Decision Tree (tsxv split) + Gráficas + BDS</span>
<span class="c1"># =======================</span>

<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">jarque_bera</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">bds</span>
    <span class="n">HAS_BDS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">HAS_BDS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aviso: no se pudo importar bds; se omite BDS.&quot;</span><span class="p">)</span>

<span class="c1"># ---- estilo idéntico ----</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;#333&quot;</span><span class="p">,</span><span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span><span class="s2">&quot;legend.frameon&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
<span class="n">COL_REAL</span><span class="p">,</span> <span class="n">COL_PRED</span><span class="p">,</span> <span class="n">COL_ERR</span> <span class="o">=</span> <span class="s2">&quot;#e76f51&quot;</span><span class="p">,</span> <span class="s2">&quot;#b08d57&quot;</span><span class="p">,</span> <span class="s2">&quot;#9aa0a6&quot;</span>
<span class="n">H_GRAPH</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># h=0 (t+1)</span>

<span class="c1"># ---- utils ----</span>
<span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())))</span>
<span class="k">def</span> <span class="nf">MAE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">sMAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">last_block_dates</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]);</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">;</span> <span class="n">start</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">);</span> <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_bds</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BDS</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;BDS no disponible.&quot;</span>
    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">();</span> <span class="n">stats</span><span class="p">,</span><span class="n">pvals</span><span class="o">=</span><span class="n">bds</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">max_dim</span><span class="o">=</span><span class="n">max_dim</span><span class="p">)</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">stats</span><span class="p">)));</span> <span class="n">lines</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">: p=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">))]</span>
    <span class="n">concl</span><span class="o">=</span><span class="s2">&quot;Rechazamos H0 — residuos NO independientes.&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;No rechazamos H0 — residuos independientes.&quot;</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; || &quot;</span><span class="o">+</span><span class="n">concl</span>

<span class="c1"># ===== 1) Entrena en TRAIN y valida en VAL =====</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>               <span class="c1"># multi-output nativo</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">y_cv_pred</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>

<span class="c1"># ===== 2) Reentrena en TRAIN+VAL y evalúa en TEST =====</span>
<span class="n">dt_final</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dt_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]))</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">dt_final</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>

<span class="c1"># ===== 3) Métricas + BDS =====</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Decision Tree] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">resid_h0</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Decision Tree] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># ===== 4) Gráficas estilo compañera =====</span>
<span class="n">Nte</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Ntr</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ytest</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ycv</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">test_dates</span>  <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nte</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">val_dates</span>   <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="p">)</span>
<span class="n">train_dates</span> <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Ntr</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="o">+</span><span class="n">Nva</span><span class="p">)</span>

<span class="c1"># General 3x3</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span> <span class="n">gs</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Valores Reales (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicciones (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicciones vs Valores Reales - Decision Tree (TEST)&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">miv</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">mav</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],[</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea perfecta&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dispersión: Real vs Predicho (TEST)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Valores Reales&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicciones&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">resid_h0</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuos del Modelo (TEST)&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Residuos (TEST)&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">imp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dt_final</span><span class="p">,</span><span class="s2">&quot;feature_importances_&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
<span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
<span class="n">top_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">imp</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:];</span> <span class="n">fi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feat_names</span><span class="p">)[</span><span class="n">top_idx</span><span class="p">],</span><span class="s2">&quot;importance&quot;</span><span class="p">:</span><span class="n">imp</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)),</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)));</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importancia&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 10 Features Importantes&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mape_val</span><span class="o">=</span><span class="n">MAPE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">mae_val</span><span class="o">=</span><span class="n">MAE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">rmse_val</span><span class="o">=</span><span class="n">RMSE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([[</span><span class="n">mape_val</span><span class="p">],[</span><span class="n">mae_val</span><span class="p">],[</span><span class="n">rmse_val</span><span class="p">]],</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">,</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Métricas CV (Validación)&#39;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">ax7</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">ax7</span><span class="p">);</span> <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de Residuos (TEST)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Análisis General - Decision Tree - Series Temporales&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Por conjunto</span>
<span class="n">fig2</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TRAIN - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto VALIDATION - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Test)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Test - final_model)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TEST - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Decision Tree] Métricas
Train: MAPE=60923442.5139% | MAE=0.593727 | RMSE=0.880555
  Val: MAPE=68007300.0792% | MAE=0.616334 | RMSE=0.949099 | sMAPE=63.05%
 Test: MAPE=62111948.2259% | MAE=0.576209 | RMSE=1.004173 | sMAPE=58.62%
[Decision Tree] BDS (residuos TEST, h=t+1): m=2: p=6.32e-14 | m=3: p=1.68e-10 | m=4: p=4.29e-07 | m=5: p=1.21e-05 | m=6: p=0.000174 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/2548301883.py:96: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;]); ax6.set_title(&#39;Distribución de Métricas CV (Validación)&#39;); ax6.set_ylabel(&#39;Valor&#39;)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/2548301883.py:100: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.suptitle(&#39;Análisis General - Decision Tree - Series Temporales&#39;,fontsize=18,fontweight=&#39;bold&#39;); plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/ec6cd52bd8e2ba07faa6785ced36ce9789180d19579360ec31f822d65ad441b8.png" src="_images/ec6cd52bd8e2ba07faa6785ced36ce9789180d19579360ec31f822d65ad441b8.png" />
<img alt="_images/b473cf4664bd28a92a2b4a336e1035da74bf2a144c04f35bbd9e0e2cf371ab6b.png" src="_images/b473cf4664bd28a92a2b4a336e1035da74bf2a144c04f35bbd9e0e2cf371ab6b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">joblib</span>

<span class="c1"># Guardar el modelo</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dt_final</span><span class="p">,</span> <span class="s1">&#39;models_all/detree_final_timeSplit.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;models_all/detree_final_timeSplit.pkl&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="random-forest">
<h1>Random Forest<a class="headerlink" href="#random-forest" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================</span>
<span class="c1"># Random Forest (tsxv split) + Gráficas estilo compañera + BDS</span>
<span class="c1"># =======================</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">jarque_bera</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">bds</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aviso: no se pudo importar bds; se omite BDS.&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;#333&quot;</span><span class="p">,</span><span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span><span class="s2">&quot;legend.frameon&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
<span class="n">COL_REAL</span><span class="p">,</span> <span class="n">COL_PRED</span><span class="p">,</span> <span class="n">COL_ERR</span> <span class="o">=</span> <span class="s2">&quot;#e76f51&quot;</span><span class="p">,</span> <span class="s2">&quot;#b08d57&quot;</span><span class="p">,</span> <span class="s2">&quot;#9aa0a6&quot;</span><span class="p">;</span> <span class="n">H_GRAPH</span><span class="o">=</span><span class="mi">0</span>

<span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())))</span>
<span class="k">def</span> <span class="nf">MAE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">sMAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">last_block_dates</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]);</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">;</span> <span class="n">start</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">);</span> <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_bds</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span><span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BDS</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;BDS no disponible.&quot;</span>
    <span class="n">stats</span><span class="p">,</span><span class="n">pvals</span><span class="o">=</span><span class="n">bds</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">max_dim</span><span class="o">=</span><span class="n">max_dim</span><span class="p">)</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">stats</span><span class="p">)));</span> <span class="n">lines</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">: p=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">))]</span>
    <span class="n">concl</span><span class="o">=</span><span class="s2">&quot;Rechazamos H0 — residuos NO independientes.&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;No rechazamos H0 — residuos independientes.&quot;</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; || &quot;</span><span class="o">+</span><span class="n">concl</span>

<span class="c1"># 1) Train-&gt;Val</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="n">y_cv_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>

<span class="c1"># 2) Train+Val-&gt;Test</span>
<span class="n">rf_final</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]))</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">rf_final</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>

<span class="c1"># 3) Métricas + BDS</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Random Forest] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">resid_h0</span><span class="o">=</span><span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Random Forest] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">))</span>

<span class="c1"># 4) Gráficas (idénticas)</span>
<span class="n">Nte</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Ntr</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ytest</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ycv</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">test_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nte</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="n">val_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Nte</span><span class="p">);</span> <span class="n">train_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Ntr</span><span class="p">,</span><span class="n">Nte</span><span class="o">+</span><span class="n">Nva</span><span class="p">)</span>

<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span> <span class="n">gs</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Valores Reales (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicciones (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicciones vs Valores Reales - Random Forest (TEST)&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">miv</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">mav</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],[</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea perfecta&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dispersión: Real vs Predicho (TEST)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Valores Reales&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicciones&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">resid_h0</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuos del Modelo (TEST)&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Residuos (TEST)&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">imp</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">rf_final</span><span class="p">,</span><span class="s2">&quot;feature_importances_&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
<span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])];</span> <span class="n">top_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">imp</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
<span class="n">fi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feat_names</span><span class="p">)[</span><span class="n">top_idx</span><span class="p">],</span><span class="s2">&quot;importance&quot;</span><span class="p">:</span><span class="n">imp</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)),</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)));</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importancia&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 10 Features Importantes&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mape_val</span><span class="o">=</span><span class="n">MAPE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">mae_val</span><span class="o">=</span><span class="n">MAE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">rmse_val</span><span class="o">=</span><span class="n">RMSE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([[</span><span class="n">mape_val</span><span class="p">],[</span><span class="n">mae_val</span><span class="p">],[</span><span class="n">rmse_val</span><span class="p">]],</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">,</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Métricas CV (Validación)&#39;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">ax7</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">ax7</span><span class="p">);</span> <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de Residuos (TEST)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Análisis General - Random Forest - Series Temporales&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig2</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TRAIN - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto VALIDATION - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Test)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Test - final_model)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TEST - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Random Forest] Métricas
Train: MAPE=18071639.7888% | MAE=0.176111 | RMSE=0.295977
  Val: MAPE=30454236.9005% | MAE=0.271871 | RMSE=0.570564 | sMAPE=30.58%
 Test: MAPE=32281029.6121% | MAE=0.232165 | RMSE=0.565599 | sMAPE=26.19%
[Random Forest] BDS (residuos TEST, h=t+1): m=2: p=0.497 | m=3: p=0.966 | m=4: p=0.496 | m=5: p=0.482 | m=6: p=0.595 || No rechazamos H0 — residuos independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1945060331.py:84: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;]); ax6.set_title(&#39;Distribución de Métricas CV (Validación)&#39;); ax6.set_ylabel(&#39;Valor&#39;)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1945060331.py:88: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.suptitle(&#39;Análisis General - Random Forest - Series Temporales&#39;,fontsize=18,fontweight=&#39;bold&#39;); plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/a61e928044c1db3461898c2f9882e3704432a74e79f13633d92a6a13417688d2.png" src="_images/a61e928044c1db3461898c2f9882e3704432a74e79f13633d92a6a13417688d2.png" />
<img alt="_images/b59001ec7e2f662524e828f266c1699f5543c50e171a9749f331204c900e57bd.png" src="_images/b59001ec7e2f662524e828f266c1699f5543c50e171a9749f331204c900e57bd.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-xgboost">
<h1>Modelo XGBoost<a class="headerlink" href="#modelo-xgboost" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================</span>
<span class="c1"># XGBoost (tsxv split) + Gráficas estilo compañera + BDS</span>
<span class="c1"># =======================</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">jarque_bera</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">subprocess</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="s2">&quot;install&quot;</span><span class="p">,</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span><span class="s2">&quot;xgboost&quot;</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">bds</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aviso: no se pudo importar bds; se omite BDS.&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;#333&quot;</span><span class="p">,</span><span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span><span class="s2">&quot;legend.frameon&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
<span class="n">COL_REAL</span><span class="p">,</span> <span class="n">COL_PRED</span><span class="p">,</span> <span class="n">COL_ERR</span> <span class="o">=</span> <span class="s2">&quot;#e76f51&quot;</span><span class="p">,</span> <span class="s2">&quot;#b08d57&quot;</span><span class="p">,</span> <span class="s2">&quot;#9aa0a6&quot;</span><span class="p">;</span> <span class="n">H_GRAPH</span><span class="o">=</span><span class="mi">0</span>

<span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())))</span>
<span class="k">def</span> <span class="nf">MAE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">sMAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">last_block_dates</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]);</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">;</span> <span class="n">start</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">);</span> <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_bds</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span><span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BDS</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;BDS no disponible.&quot;</span>
    <span class="n">stats</span><span class="p">,</span><span class="n">pvals</span><span class="o">=</span><span class="n">bds</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res_1d</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">max_dim</span><span class="o">=</span><span class="n">max_dim</span><span class="p">)</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">stats</span><span class="p">)));</span> <span class="n">lines</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">: p=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">))]</span>
    <span class="n">concl</span><span class="o">=</span><span class="s2">&quot;Rechazamos H0 — residuos NO independientes.&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;No rechazamos H0 — residuos independientes.&quot;</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; || &quot;</span><span class="o">+</span><span class="n">concl</span>

<span class="c1"># 1) Base XGB y wrapper multi-output</span>
<span class="n">xgb_base</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reg_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;reg:squarederror&quot;</span><span class="p">,</span> <span class="n">tree_method</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
<span class="n">xgb</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">xgb_base</span><span class="p">)</span>

<span class="c1"># 2) Train-&gt;Val</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span> <span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="n">y_cv_pred</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>

<span class="c1"># 3) Train+Val-&gt;Test</span>
<span class="n">xgb_final</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">xgb_base</span><span class="o">.</span><span class="n">get_params</span><span class="p">()))</span>
<span class="n">xgb_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]))</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">xgb_final</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>

<span class="c1"># 4) Métricas + BDS</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[XGBoost] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">resid_h0</span><span class="o">=</span><span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[XGBoost] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">))</span>

<span class="c1"># 5) Importancias promedio sobre salidas</span>
<span class="n">n_feats</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">imps</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">xgb_final</span><span class="o">.</span><span class="n">estimators_</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="s2">&quot;feature_importances_&quot;</span><span class="p">):</span>
        <span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">!=</span><span class="n">n_feats</span><span class="p">:</span> <span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n_feats</span><span class="p">)</span>
        <span class="n">imps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="n">imp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imps</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_feats</span><span class="p">)</span>

<span class="c1"># 6) Gráficas</span>
<span class="n">Nte</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Ntr</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ytest</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ycv</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">test_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nte</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="n">val_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Nva</span><span class="p">,</span><span class="n">Nte</span><span class="p">);</span> <span class="n">train_dates</span><span class="o">=</span><span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">Ntr</span><span class="p">,</span><span class="n">Nte</span><span class="o">+</span><span class="n">Nva</span><span class="p">)</span>

<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span> <span class="n">gs</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Valores Reales (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicciones (Test)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicciones vs Valores Reales - XGBoost (TEST)&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">miv</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">mav</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],[</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea perfecta&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dispersión: Real vs Predicho (TEST)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Valores Reales&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicciones&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">resid_h0</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuos del Modelo (TEST)&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Residuos (TEST)&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_feats</span><span class="p">)]</span>
<span class="n">top_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">imp</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:];</span> <span class="n">fi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feat_names</span><span class="p">)[</span><span class="n">top_idx</span><span class="p">],</span><span class="s2">&quot;importance&quot;</span><span class="p">:</span><span class="n">imp</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)),</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)));</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importancia&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 10 Features Importantes&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mape_val</span><span class="o">=</span><span class="n">MAPE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">mae_val</span><span class="o">=</span><span class="n">MAE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">);</span> <span class="n">rmse_val</span><span class="o">=</span><span class="n">RMSE</span><span class="p">(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([[</span><span class="n">mape_val</span><span class="p">],[</span><span class="n">mae_val</span><span class="p">],[</span><span class="n">rmse_val</span><span class="p">]],</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">,</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Métricas CV (Validación)&#39;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">ax7</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">ax7</span><span class="p">);</span> <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de Residuos (TEST)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Análisis General - XGBoost - Series Temporales&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig2</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Train)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TRAIN - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Val)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span><span class="n">ycv</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_cv_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto VALIDATION - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Test)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="s1">&#39;s-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Test - final_model)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span><span class="n">ytest</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TEST - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[XGBoost] Métricas
Train: MAPE=36936.3070% | MAE=0.000297 | RMSE=0.000358
  Val: MAPE=18534984.1555% | MAE=0.146771 | RMSE=0.517411 | sMAPE=17.41%
 Test: MAPE=24877618.7023% | MAE=0.147315 | RMSE=0.510887 | sMAPE=17.48%
[XGBoost] BDS (residuos TEST, h=t+1): m=2: p=0.161 | m=3: p=0.0478 | m=4: p=0.465 | m=5: p=0.708 | m=6: p=0.714 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1029435192.py:108: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;]); ax6.set_title(&#39;Distribución de Métricas CV (Validación)&#39;); ax6.set_ylabel(&#39;Valor&#39;)
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1029435192.py:112: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.suptitle(&#39;Análisis General - XGBoost - Series Temporales&#39;,fontsize=18,fontweight=&#39;bold&#39;); plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/9201bb24a7cd66dbcb1dc3921890ff7cd240840c527ae73f1c4f75ca8c1b4bd2.png" src="_images/9201bb24a7cd66dbcb1dc3921890ff7cd240840c527ae73f1c4f75ca8c1b4bd2.png" />
<img alt="_images/555a9437167d8c589a1eb5484f84d4619b43cb9af20150eeb6ddff16a5939a82.png" src="_images/555a9437167d8c589a1eb5484f84d4619b43cb9af20150eeb6ddff16a5939a82.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-svr">
<h1>Modelo SVR<a class="headerlink" href="#modelo-svr" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>

<span class="n">svr_test</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">SVR</span><span class="p">())</span>
<span class="n">svr_test</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">estimator__kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                    <span class="n">estimator__C</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">estimator__epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">estimator__gamma</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>
<span class="n">svr_test</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">svr_test</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>  <span class="c1"># debería ejecutar sin TypeError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================</span>
<span class="c1"># SVR (stand-alone, sin helper) — multi-salida con MultiOutputRegressor</span>
<span class="c1"># =======================</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>

<span class="c1"># 1) Instancia correcta (NO usar estimator__C en __init__)</span>
<span class="n">svr_tr</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span>
    <span class="n">SVR</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># 2) Entrena en TRAIN y evalúa en VAL</span>
<span class="n">svr_tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">svr_tr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">y_cv_pred</span> <span class="o">=</span> <span class="n">svr_tr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xcv</span><span class="p">)</span>

<span class="c1"># 3) Reentrena en TRAIN+VAL y evalúa en TEST (nuevo objeto)</span>
<span class="n">svr_tv</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span>
    <span class="n">SVR</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">svr_tv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">ycv</span><span class="p">]))</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">svr_tv</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>

<span class="c1"># 4) Métricas + BDS (h=0)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SVR (RBF)] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_cv_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="n">resid_h0</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SVR (RBF)] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># 5) Importancias (SVR RBF no tiene coef_ ⇒ vector de ceros para el panel)</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># 6) Gráficas estilo compañera</span>
<span class="n">plot_like_partner</span><span class="p">(</span><span class="s2">&quot;SVR (linear)&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span>
                  <span class="n">y_tr_pred</span><span class="p">,</span> <span class="n">y_cv_pred</span><span class="p">,</span> <span class="n">y_te_pred</span><span class="p">,</span> <span class="n">importances</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[SVR (RBF)] Métricas
Train: MAPE=1788404.9668% | MAE=0.016497 | RMSE=0.020847
  Val: MAPE=33603197.6966% | MAE=0.282873 | RMSE=0.673387 | sMAPE=31.18%
 Test: MAPE=48926776.8399% | MAE=0.322745 | RMSE=0.739414 | sMAPE=33.70%
[SVR (RBF)] BDS (residuos TEST, h=t+1): m=2: p=0.0429 | m=3: p=0.00419 | m=4: p=0.113 | m=5: p=0.198 | m=6: p=0.17 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:123: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:130: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/358926f97d26a40e5e9e62bdc0f90de521132d05c96979df4c6dc2befc4a2ce7.png" src="_images/358926f97d26a40e5e9e62bdc0f90de521132d05c96979df4c6dc2befc4a2ce7.png" />
<img alt="_images/ea0987a539b85cf0461dc516f6931bbfa8e1fd5f0a49bb0400121e05815ab1e5.png" src="_images/ea0987a539b85cf0461dc516f6931bbfa8e1fd5f0a49bb0400121e05815ab1e5.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-mlp">
<h1>Modelo MLP<a class="headerlink" href="#modelo-mlp" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== MLP en PyTorch (multi-salida) =====</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

<span class="k">class</span> <span class="nc">MLPtorch</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">],</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span><span class="o">=</span><span class="p">[];</span> <span class="n">in_f</span><span class="o">=</span><span class="n">lookback</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hidden</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_f</span><span class="p">,</span><span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p_drop</span><span class="p">)]</span>
            <span class="n">in_f</span><span class="o">=</span><span class="n">h</span>
        <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_f</span><span class="p">,</span> <span class="n">horizon</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>            <span class="c1"># x: [B, L]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>           <span class="c1"># -&gt; [B, H]</span>

<span class="k">def</span> <span class="nf">train_torch</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">Xva</span><span class="p">,</span> <span class="n">yva</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">opt</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">tr_ds</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">Xtr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">ytr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">va_ds</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">Xva</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">yva</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">tr_ld</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">tr_ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">va_ld</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">va_ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">best</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">);</span> <span class="n">best_state</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">tr_ld</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">yhat</span><span class="o">=</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">);</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span><span class="n">yb</span><span class="p">);</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">ys</span><span class="o">=</span><span class="p">[];</span> <span class="n">yps</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">va_ld</span><span class="p">:</span>
                <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">yp</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">();</span> <span class="n">yps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="p">);</span> <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">RMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">yps</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rmse</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span> <span class="n">best</span><span class="o">=</span><span class="n">rmse</span><span class="p">;</span> <span class="n">best_state</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()};</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">wait</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">wait</span><span class="o">&gt;=</span><span class="n">patience</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_state</span><span class="p">:</span> <span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">net</span><span class="p">,</span> <span class="n">best</span>

<span class="k">def</span> <span class="nf">predict_torch</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xarr</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="n">ld</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">Xarr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Xarr</span><span class="p">),</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">float</span><span class="p">()),</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">:</span>
            <span class="n">xb</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="c1"># --- entrenar ---</span>
<span class="c1">#mlp = MLPtorch(lookback=X.shape[1], horizon=HORIZON, hidden=[512,256], p_drop=0.2).to(DEVICE)</span>

<span class="c1"># ============== CORRECCIÓN: Aplanar y para que sea 2D ==============</span>
<span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aplanando y de </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> a (</span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ycv</span> <span class="o">=</span> <span class="n">ycv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ytest</span> <span class="o">=</span> <span class="n">ytest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ytest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">n_outputs</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Debería ser 14 (7 pasos × 2 características)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X.shape: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, y.shape: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modelo configurado para predecir </span><span class="si">{</span><span class="n">n_outputs</span><span class="si">}</span><span class="s2"> valores&quot;</span><span class="p">)</span>


<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLPtorch</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">horizon</span><span class="o">=</span><span class="n">n_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">256</span><span class="p">],</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="n">mlp</span><span class="p">,</span> <span class="n">best_rmse_val</span> <span class="o">=</span> <span class="n">train_torch</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">predict_torch</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">y_va_pred</span> <span class="o">=</span> <span class="n">predict_torch</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">)</span>

<span class="c1"># Reentrenar Train+Val</span>
<span class="n">mlp_final</span> <span class="o">=</span> <span class="n">MLPtorch</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">horizon</span><span class="o">=</span><span class="n">n_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">256</span><span class="p">],</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">mlp_final</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_torch</span><span class="p">(</span><span class="n">mlp_final</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]),</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">predict_torch</span><span class="p">(</span><span class="n">mlp_final</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">)</span>

<span class="c1"># Métricas + BDS + plots</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[MLP] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[MLP] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">plot_like_partner</span><span class="p">(</span><span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span><span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X.shape: (208, 1000), y.shape: (208, 14)
Modelo configurado para predecir 14 valores

[MLP] Métricas
Train: MAPE=7219044.7557% | MAE=0.862112 | RMSE=1.188377
  Val: MAPE=7681957.0419% | MAE=0.862310 | RMSE=1.238791 | sMAPE=116.85%
 Test: MAPE=8623678.1473% | MAE=0.859353 | RMSE=1.231493 | sMAPE=116.27%
[MLP] BDS (residuos TEST, h=t+1): m=2: p=1.78e-224 | m=3: p=5.33e-206 | m=4: p=6.64e-191 | m=5: p=1.37e-196 | m=6: p=1.96e-210 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:123: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:130: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/403838d6f45e0b3646f5ada1400d0b6fc2367598f42f0a9386b271d239091250.png" src="_images/403838d6f45e0b3646f5ada1400d0b6fc2367598f42f0a9386b271d239091250.png" />
<img alt="_images/6ebc4f377ec1712874f9bdf80cd1fcac0d6418d5933ee502613b7dbed597ef04.png" src="_images/6ebc4f377ec1712874f9bdf80cd1fcac0d6418d5933ee502613b7dbed597ef04.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-de-rnn">
<h1>Modelo de RNN<a class="headerlink" href="#modelo-de-rnn" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== RNN simple =====</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

<span class="k">def</span> <span class="nf">to_seq</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>  <span class="c1"># [N,L] -&gt; [N,L,1]</span>
    <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RNNReg</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                          <span class="n">nonlinearity</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span> <span class="k">if</span> <span class="n">layers</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">p_drop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p_drop</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">*</span> <span class="n">num_features</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>             <span class="c1"># x: [B,L] o [B,L,1]</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">o</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>             <span class="c1"># [B,L,H]</span>
        <span class="n">h_last</span> <span class="o">=</span> <span class="n">o</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>          <span class="c1"># [B,H]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">h_last</span><span class="p">)</span>      <span class="c1"># [B,HOR]</span>

<span class="k">def</span> <span class="nf">train_rnn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">Xva</span><span class="p">,</span> <span class="n">yva</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>

    <span class="c1"># Aplanar y si tiene más de 2 dimensiones</span>
    <span class="k">if</span> <span class="n">ytr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ytr</span> <span class="o">=</span> <span class="n">ytr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ytr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yva</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">yva</span> <span class="o">=</span> <span class="n">yva</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">yva</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">tr</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xtr</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">ytr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">va</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xva</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">yva</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">tl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">vl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">);</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">best</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">);</span> <span class="n">best_state</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">tl</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">yp</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">);</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span><span class="n">yb</span><span class="p">);</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">Ys</span><span class="o">=</span><span class="p">[];</span> <span class="n">YPs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">:</span>
                <span class="n">xb</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">YPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">());</span> <span class="n">Ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">RMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Ys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">YPs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rmse</span><span class="o">&lt;</span><span class="n">best</span><span class="p">:</span> <span class="n">best</span><span class="o">=</span><span class="n">rmse</span><span class="p">;</span> <span class="n">best_state</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()};</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">wait</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">wait</span><span class="o">&gt;=</span><span class="n">patience</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_state</span><span class="p">:</span> <span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">net</span><span class="p">,</span> <span class="n">best</span>

<span class="k">def</span> <span class="nf">predict_rnn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xarr</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="n">ds</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xarr</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xarr</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ld</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span> <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">:</span>
            <span class="n">xb</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">rnn</span> <span class="o">=</span> <span class="n">RNNReg</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">rnn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_rnn</span><span class="p">(</span><span class="n">rnn</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">predict_rnn</span><span class="p">(</span><span class="n">rnn</span><span class="p">,</span> <span class="n">X</span><span class="p">);</span> <span class="n">y_va_pred</span> <span class="o">=</span> <span class="n">predict_rnn</span><span class="p">(</span><span class="n">rnn</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">)</span>

<span class="n">rnn_final</span> <span class="o">=</span> <span class="n">RNNReg</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">rnn_final</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_rnn</span><span class="p">(</span><span class="n">rnn_final</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]),</span> <span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span>
                         <span class="n">epochs</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">predict_rnn</span><span class="p">(</span><span class="n">rnn_final</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[RNN] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[RNN] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">plot_like_partner</span><span class="p">(</span><span class="s2">&quot;RNN&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span><span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[RNN] Métricas
Train: MAPE=57602076.0738% | MAE=0.476071 | RMSE=0.758783
  Val: MAPE=60909076.6167% | MAE=0.502106 | RMSE=0.831701 | sMAPE=53.39%
 Test: MAPE=61465484.3764% | MAE=0.456823 | RMSE=0.790216 | sMAPE=49.71%
[RNN] BDS (residuos TEST, h=t+1): m=2: p=9.84e-10 | m=3: p=2.94e-09 | m=4: p=1.13e-08 | m=5: p=6.37e-08 | m=6: p=4.72e-07 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:123: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:130: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/45842194a863ca5d5830206a74da2dcf6df90c7c888695a6b6cee3b0d6293e77.png" src="_images/45842194a863ca5d5830206a74da2dcf6df90c7c888695a6b6cee3b0d6293e77.png" />
<img alt="_images/5df7f71af1ad318ae90235b5a713a792a41830939b7b23910b093d3f72ce14eb.png" src="_images/5df7f71af1ad318ae90235b5a713a792a41830939b7b23910b093d3f72ce14eb.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-de-lstm">
<h1>Modelo de LSTM<a class="headerlink" href="#modelo-de-lstm" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== LSTM =====</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

<span class="k">def</span> <span class="nf">to_seq</span><span class="p">(</span><span class="n">X</span><span class="p">):</span> <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSTMReg</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span> <span class="k">if</span> <span class="n">layers</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">p_drop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p_drop</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">*</span> <span class="n">num_features</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">o</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>             <span class="c1"># [B,L,H]</span>
        <span class="n">h_last</span> <span class="o">=</span> <span class="n">o</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">h_last</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train_lstm</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">Xva</span><span class="p">,</span> <span class="n">yva</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">tr</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xtr</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">ytr</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">va</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xva</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">yva</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">tl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">vl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">);</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">best</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">);</span> <span class="n">best_state</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">tl</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">yp</span><span class="o">=</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">);</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span><span class="n">yb</span><span class="p">);</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">Ys</span><span class="o">=</span><span class="p">[];</span> <span class="n">YPs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">:</span>
                <span class="n">xb</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">YPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">());</span> <span class="n">Ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">RMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Ys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">YPs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rmse</span><span class="o">&lt;</span><span class="n">best</span><span class="p">:</span> <span class="n">best</span><span class="o">=</span><span class="n">rmse</span><span class="p">;</span> <span class="n">best_state</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()};</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">wait</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">wait</span><span class="o">&gt;=</span><span class="n">patience</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_state</span><span class="p">:</span> <span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">net</span><span class="p">,</span> <span class="n">best</span>

<span class="k">def</span> <span class="nf">predict_lstm</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">Xarr</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="n">ds</span><span class="o">=</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">to_seq</span><span class="p">(</span><span class="n">Xarr</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xarr</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ld</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span> <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">:</span>
            <span class="n">xb</span><span class="o">=</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">);</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">lstm</span> <span class="o">=</span> <span class="n">LSTMReg</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">lstm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_lstm</span><span class="p">(</span><span class="n">lstm</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">predict_lstm</span><span class="p">(</span><span class="n">lstm</span><span class="p">,</span> <span class="n">X</span><span class="p">);</span> <span class="n">y_va_pred</span> <span class="o">=</span> <span class="n">predict_lstm</span><span class="p">(</span><span class="n">lstm</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">)</span>

<span class="n">lstm_final</span> <span class="o">=</span> <span class="n">LSTMReg</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">,</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">lstm_final</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_lstm</span><span class="p">(</span><span class="n">lstm_final</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Xcv</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">ycv</span><span class="p">]),</span> <span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span>
                           <span class="n">epochs</span><span class="o">=</span><span class="mi">550</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">predict_lstm</span><span class="p">(</span><span class="n">lstm_final</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[LSTM] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">y</span><span class="p">,</span><span class="n">y_tr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">ycv</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">ytest</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[LSTM] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y_te_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">plot_like_partner</span><span class="p">(</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Xcv</span><span class="p">,</span><span class="n">ycv</span><span class="p">,</span><span class="n">Xtest</span><span class="p">,</span><span class="n">ytest</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">,</span><span class="n">y_va_pred</span><span class="p">,</span><span class="n">y_te_pred</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LSTM] Métricas
Train: MAPE=22668965.4429% | MAE=0.214995 | RMSE=0.376890
  Val: MAPE=31433284.9546% | MAE=0.281827 | RMSE=0.539617 | sMAPE=31.54%
 Test: MAPE=35681257.9861% | MAE=0.232375 | RMSE=0.485876 | sMAPE=27.64%
[LSTM] BDS (residuos TEST, h=t+1): m=2: p=0.732 | m=3: p=0.759 | m=4: p=0.374 | m=5: p=0.342 | m=6: p=0.405 || No rechazamos H0 — residuos independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:123: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]],labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1796777802.py:130: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/b6e950b179373978621d572bf59fb05a2731400f4bd6c1ec37f222c4084c570c.png" src="_images/b6e950b179373978621d572bf59fb05a2731400f4bd6c1ec37f222c4084c570c.png" />
<img alt="_images/1be512cf7d9d621dda6ae46bd0633ac51940331cfbaa5844e3b7de4771dcd3b8.png" src="_images/1be512cf7d9d621dda6ae46bd0633ac51940331cfbaa5844e3b7de4771dcd3b8.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-n-beast-bayesian">
<h1>Modelo  N-Beast Bayesian<a class="headerlink" href="#modelo-n-beast-bayesian" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =========================</span>
<span class="c1"># N-BEATS ROBUSTO (UPGRADE)</span>
<span class="c1"># =========================</span>
<span class="k">class</span> <span class="nc">TrendBasis</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lookback</span><span class="p">)</span>
        <span class="n">Phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">t</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [p, L]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="n">Phi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>  <span class="c1"># [B,p] @ [p,L] -&gt; [B,L]</span>
        <span class="k">return</span> <span class="n">theta</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span>

<span class="k">class</span> <span class="nc">SeasonBasis</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">lookback</span><span class="p">)</span>
        <span class="n">sines</span>  <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">cosines</span><span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">Phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sines</span> <span class="o">+</span> <span class="n">cosines</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>           <span class="c1"># [2K, L]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="n">Phi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">K</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">theta</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span>

<span class="k">class</span> <span class="nc">InterpretableBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;trend&quot;</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lookback</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p_drop</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">basis</span> <span class="o">==</span> <span class="s2">&quot;trend&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">back_basis</span> <span class="o">=</span> <span class="n">TrendBasis</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span> <span class="n">theta_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_basis</span><span class="o">.</span><span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">back_basis</span> <span class="o">=</span> <span class="n">SeasonBasis</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">4</span><span class="p">);</span>     <span class="n">theta_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_basis</span><span class="o">.</span><span class="n">k2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theta_b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">theta_b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_f</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">*</span> <span class="n">num_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_outputs</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;x </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">backcast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_b</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_f</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backcast</span><span class="p">,</span> <span class="n">forecast</span>

<span class="k">class</span> <span class="nc">NBeatsInterpretable</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_pairs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InterpretableBlock</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;trend&quot;</span><span class="p">,</span>  <span class="n">p_drop</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InterpretableBlock</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">num_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;season&quot;</span><span class="p">,</span> <span class="n">p_drop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span> <span class="n">num_outputs</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">forecast_total</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">blk</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
            <span class="n">residual</span>       <span class="o">=</span> <span class="n">residual</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">forecast_total</span> <span class="o">=</span> <span class="n">forecast_total</span> <span class="o">+</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">forecast_total</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
              <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">loss_type</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">horizon_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>
    <span class="n">base_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span> <span class="k">if</span> <span class="n">loss_type</span><span class="o">==</span><span class="s2">&quot;mse&quot;</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># &gt;&gt;&gt; CAMBIA ESTA LÍNEA: quita &#39;verbose&#39;</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
        <span class="n">opt</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">threshold_mode</span><span class="o">=</span><span class="s1">&#39;rel&#39;</span><span class="p">,</span> <span class="n">cooldown</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span>
        <span class="c1"># verbose= False   # &lt;--- ELIMINADO</span>
    <span class="p">)</span>

    <span class="n">best_state</span><span class="p">,</span> <span class="n">best_rmse</span><span class="p">,</span> <span class="n">wait</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">get_lr</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
    <span class="n">prev_lr</span> <span class="o">=</span> <span class="n">get_lr</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Entrenando N-BEATS (RMSE Val)&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">horizon_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">base_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">horizon_weights</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;mse&quot;</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">yb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">yb</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clip_grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">clip_grad</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># --- Validación</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="n">Yt</span><span class="p">,</span> <span class="n">Yp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">Yp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="p">);</span> <span class="n">Yt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">rmse_val</span> <span class="o">=</span> <span class="n">RMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Yt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Yp</span><span class="p">))</span>

        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">rmse_val</span><span class="p">)</span>

        <span class="c1"># (Opcional) Mensaje cuando baje el LR</span>
        <span class="n">cur_lr</span> <span class="o">=</span> <span class="n">get_lr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur_lr</span> <span class="o">&lt;</span> <span class="n">prev_lr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">_tqdm</span>
                <span class="n">_tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[scheduler] LR: </span><span class="si">{</span><span class="n">prev_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">cur_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[scheduler] LR: </span><span class="si">{</span><span class="n">prev_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">cur_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prev_lr</span> <span class="o">=</span> <span class="n">cur_lr</span>

        <span class="k">if</span> <span class="n">rmse_val</span> <span class="o">&lt;</span> <span class="n">best_rmse</span><span class="p">:</span>
            <span class="n">best_rmse</span><span class="p">,</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">rmse_val</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">best_state</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wait</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">wait</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">best_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">best_rmse</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">retrain_on_trainval</span><span class="p">(</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">Xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span>
                        <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                        <span class="n">weight_decay</span><span class="o">=</span><span class="mf">2e-4</span><span class="p">,</span>           <span class="c1"># ↑ regularización leve</span>
                        <span class="n">loss_type</span><span class="o">=</span><span class="s2">&quot;huber&quot;</span><span class="p">,</span>           <span class="c1"># &quot;mse&quot; o &quot;huber&quot;</span>
                        <span class="n">horizon_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>        <span class="c1"># e.g. np.array([3,2,1,1,1,1,1], np.float32)</span>
                        <span class="n">clip_grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">bs</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                        <span class="n">from_state_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>        <span class="c1"># &lt;- pasa nbeats.state_dict() si quieres warm-start</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">from_state_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">from_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>
    <span class="n">base_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span> <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;mse&quot;</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># scheduler suave (no necesita &#39;verbose&#39;)</span>
    <span class="n">sched</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">CosineAnnealingLR</span><span class="p">(</span>
        <span class="n">opt</span><span class="p">,</span> <span class="n">T_max</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">eta_min</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">lr</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">Xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Xval</span><span class="p">]);</span> <span class="n">Yf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ytr</span><span class="p">,</span> <span class="n">yval</span><span class="p">])</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">make_loader</span><span class="p">(</span><span class="n">Xf</span><span class="p">,</span> <span class="n">Yf</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reentrenando en Train+Val&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">horizon_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">base_loss</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">horizon_weights</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">yp</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [1,H]</span>
                <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;mse&quot;</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">yp</span> <span class="o">-</span> <span class="n">yb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Huber aprox ponderada</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span> <span class="o">-</span> <span class="n">yb</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clip_grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">clip_grad</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">sched</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">mc_predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="c1"># Dropout activo en inferencia → distribución predictiva</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">preds</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;MC-Dropout sampling&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mc&quot;</span><span class="p">):</span>
            <span class="n">batch</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
                <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
                <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># [T, N, H]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lo</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">hi</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mc_predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Dropout activo</span>
    <span class="n">preds</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;MC-Dropout sampling&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mc&quot;</span><span class="p">):</span>
            <span class="n">batch</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
                <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
                <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [T, N, H]</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># --- 1) Entrenamos y seleccionamos por RMSE(Val) ---</span>
<span class="n">nbeats</span> <span class="o">=</span> <span class="n">NBeatsInterpretable</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">n_pairs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">nbeats</span><span class="p">,</span> <span class="n">best_rmse_val</span> <span class="o">=</span> <span class="n">train_fit</span><span class="p">(</span><span class="n">nbeats</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span>
                                  <span class="n">max_epochs</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor RMSE(Val): </span><span class="si">{</span><span class="n">best_rmse_val</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- 2) Conformal calibration en Validación ---</span>
<span class="n">val_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mc_predict</span><span class="p">(</span><span class="n">nbeats</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>


<span class="c1"># Extraer Yval</span>
<span class="n">Yval</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
    <span class="n">Yval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">Yval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Yval</span><span class="p">)</span>  <span class="c1"># (207, 7, 2)</span>

<span class="c1"># APLANAR ambos para que coincidan</span>
<span class="n">Yval_flat</span> <span class="o">=</span> <span class="n">Yval</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Yval</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (207, 7, 2) -&gt; (207, 14)</span>
<span class="n">val_mean_flat</span> <span class="o">=</span> <span class="n">val_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (207, 7, 2) -&gt; (207, 14)</span>

<span class="n">abs_err_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Yval_flat</span> <span class="o">-</span> <span class="n">val_mean_flat</span><span class="p">)</span>
<span class="n">q95_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">abs_err_val</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ancho por horizonte</span>

<span class="c1"># --- 3) Reentrenamos con Train+Val ---</span>
<span class="c1"># Si y está aplanado (forma 2D), necesitamos reshapearlo para N-Beats</span>
<span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">HORIZON</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># y.shape[1] = 14 (7*2)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corrigiendo dimensiones de y de </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> a (</span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">HORIZON</span><span class="si">}</span><span class="s2">, 2)&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ycv</span> <span class="o">=</span> <span class="n">ycv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ytest</span> <span class="o">=</span> <span class="n">ytest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ytest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HORIZON</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nuevas dimensiones - y: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, ycv: </span><span class="si">{</span><span class="n">ycv</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">nb_final</span> <span class="o">=</span> <span class="n">retrain_on_trainval</span><span class="p">(</span><span class="n">NBeatsInterpretable</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Xcv</span><span class="p">,</span> <span class="n">ycv</span><span class="p">,</span>
                               <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                               <span class="n">lookback</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">horizon</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">n_pairs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">p_drop</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># --- 4) MC en Test + aplicar calibración ---</span>
<span class="n">mean_te</span><span class="p">,</span> <span class="n">lo_te_mc</span><span class="p">,</span> <span class="n">hi_te_mc</span> <span class="o">=</span> <span class="n">mc_predict</span><span class="p">(</span><span class="n">nb_final</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

<span class="c1"># Necesitamos reshape q95_val a (7, 2) para que coincida</span>
<span class="n">q95_val_reshaped</span> <span class="o">=</span> <span class="n">q95_val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">HORIZON</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (14,) -&gt; (7, 2)</span>

<span class="n">lo_te_cal</span> <span class="o">=</span> <span class="n">mean_te</span> <span class="o">-</span> <span class="n">q95_val_reshaped</span>
<span class="n">hi_te_cal</span> <span class="o">=</span> <span class="n">mean_te</span> <span class="o">+</span> <span class="n">q95_val_reshaped</span>

<span class="c1"># CORRECCIÓN: Extraer Ytest con la forma correcta (3D) en lugar de aplanada (2D)</span>
<span class="n">Ytest</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
    <span class="n">Ytest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">Ytest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Ytest</span><span class="p">)</span>  <span class="c1"># Esto dará forma (206, 7, 2) en lugar de (1442, 2)</span>

<span class="n">rmse_te</span>   <span class="o">=</span> <span class="n">RMSE</span><span class="p">(</span><span class="n">Ytest</span><span class="p">,</span> <span class="n">mean_te</span><span class="p">)</span>
<span class="n">mae_te</span>    <span class="o">=</span> <span class="n">MAE</span><span class="p">(</span><span class="n">Ytest</span><span class="p">,</span> <span class="n">mean_te</span><span class="p">)</span>
<span class="n">smape_te</span>  <span class="o">=</span> <span class="n">sMAPE</span><span class="p">(</span><span class="n">Ytest</span><span class="p">,</span> <span class="n">mean_te</span><span class="p">)</span>
<span class="n">cov90_mc</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Ytest</span> <span class="o">&gt;=</span> <span class="n">lo_te_mc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Ytest</span> <span class="o">&lt;=</span> <span class="n">hi_te_mc</span><span class="p">)))</span>
<span class="n">cov90_cal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Ytest</span> <span class="o">&gt;=</span> <span class="n">lo_te_cal</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Ytest</span> <span class="o">&lt;=</span> <span class="n">hi_te_cal</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TEST] RMSE=</span><span class="si">{</span><span class="n">rmse_te</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | MAE=</span><span class="si">{</span><span class="n">mae_te</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | sMAPE=</span><span class="si">{</span><span class="n">smape_te</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coverage@90 (MC crudo)=</span><span class="si">{</span><span class="n">cov90_mc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Coverage@90 (Conformal)=</span><span class="si">{</span><span class="n">cov90_cal</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entrenando N-BEATS (RMSE Val):   4%|▎         | 22/600 [00:36&lt;07:31,  1.28epoch/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[scheduler] LR: 1.00e-03 -&gt; 5.00e-04
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entrenando N-BEATS (RMSE Val):   5%|▍         | 28/600 [00:40&lt;06:07,  1.55epoch/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[scheduler] LR: 5.00e-04 -&gt; 2.50e-04
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entrenando N-BEATS (RMSE Val):   6%|▌         | 34/600 [00:44&lt;07:06,  1.33epoch/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[scheduler] LR: 2.50e-04 -&gt; 1.25e-04
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entrenando N-BEATS (RMSE Val):   7%|▋         | 40/600 [00:50&lt;12:35,  1.35s/epoch]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[scheduler] LR: 1.25e-04 -&gt; 6.25e-05
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entrenando N-BEATS (RMSE Val):   7%|▋         | 40/600 [00:52&lt;12:09,  1.30s/epoch]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mejor RMSE(Val): 1.22419
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MC-Dropout sampling: 100%|██████████| 400/400 [01:00&lt;00:00,  6.59mc/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Corrigiendo dimensiones de y de (208, 14) a (208, 7, 2)
Nuevas dimensiones - y: (208, 7, 2), ycv: (207, 7, 2)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reentrenando en Train+Val: 100%|██████████| 300/300 [11:05&lt;00:00,  2.22s/epoch]
MC-Dropout sampling: 100%|██████████| 800/800 [01:54&lt;00:00,  6.97mc/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[TEST] RMSE=1.19763 | MAE=0.74668 | sMAPE=78.78%
Coverage@90 (MC crudo)=0.271 | Coverage@90 (Conformal)=0.914
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== Helpers MÉTRICAS + PLOTS (estilo compañera) =====</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># Estilo igual al de los otros modelos</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;husl&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;#333&quot;</span><span class="p">,</span><span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span><span class="s2">&quot;legend.frameon&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
<span class="n">COL_REAL</span><span class="p">,</span> <span class="n">COL_PRED</span><span class="p">,</span> <span class="n">COL_ERR</span> <span class="o">=</span> <span class="s2">&quot;#e76f51&quot;</span><span class="p">,</span> <span class="s2">&quot;#b08d57&quot;</span><span class="p">,</span> <span class="s2">&quot;#9aa0a6&quot;</span>
<span class="n">H_GRAPH</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># horizonte a graficar (0=t+1)</span>

<span class="c1"># Métricas (reusa tus RMSE/MAE/sMAPE si ya existen)</span>
<span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">yp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">last_block_dates</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]);</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">;</span> <span class="n">start</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># BDS (si tienes statsmodels)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">bds</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">HAS_BDS</span><span class="o">=</span><span class="kc">False</span>
<span class="k">def</span> <span class="nf">run_bds</span><span class="p">(</span><span class="n">residuals_1d</span><span class="p">,</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BDS</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;BDS no disponible.&quot;</span>
    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">residuals_1d</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">stats_b</span><span class="p">,</span><span class="n">pvals</span><span class="o">=</span><span class="n">bds</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">max_dim</span><span class="o">=</span><span class="n">max_dim</span><span class="p">)</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">stats_b</span><span class="p">)))</span>
    <span class="n">lines</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">: p=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">))]</span>
    <span class="n">concl</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Rechazamos H0 — residuos NO independientes.&quot;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span>
           <span class="s2">&quot;No rechazamos H0 — residuos independientes.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; || &quot;</span><span class="o">+</span><span class="n">concl</span>

<span class="c1"># Helper: predicciones puntuales con un modelo dado y un loader</span>
<span class="k">def</span> <span class="nf">preds_point</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">Y_true</span><span class="p">,</span> <span class="n">Y_pred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">Y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="p">);</span> <span class="n">Y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

<span class="c1"># === Plot general 3×3 + por conjunto (con banda 90% en TEST si se provee) ===</span>
<span class="k">def</span> <span class="nf">plot_like_partner_nbeats</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span>
                             <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">,</span> <span class="n">y_va</span><span class="p">,</span> <span class="n">y_va_pred</span><span class="p">,</span>
                             <span class="n">y_te</span><span class="p">,</span> <span class="n">y_te_pred_mean</span><span class="p">,</span>
                             <span class="n">df</span><span class="p">,</span> <span class="n">lookback</span><span class="p">,</span>
                             <span class="n">lo_band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hi_band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Fechas por bloque</span>
    <span class="n">Nte</span><span class="p">,</span> <span class="n">Nva</span><span class="p">,</span> <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_te</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_va</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_tr</span><span class="p">)</span>
    <span class="n">test_dates</span>  <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">Nte</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">val_dates</span>   <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">Nva</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="p">)</span>
    <span class="n">train_dates</span> <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">Nte</span><span class="o">+</span><span class="n">Nva</span><span class="p">)</span>

    <span class="c1"># Residuos TEST (h=0)</span>
    <span class="n">resid_h0</span> <span class="o">=</span> <span class="n">y_te</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># ===== Figura general =====</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span> <span class="n">gs</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

    <span class="c1"># (1) Pred vs Real TEST</span>
    <span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Valores Reales (Test)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicciones (Test)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="c1"># banda 90%</span>
    <span class="k">if</span> <span class="n">lo_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hi_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">lo_band</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">hi_band</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Banda 90%&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicciones vs Valores Reales - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> (TEST)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># (2) Dispersión TEST</span>
    <span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
    <span class="n">miv</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">mav</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],[</span><span class="n">miv</span><span class="p">,</span><span class="n">mav</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea perfecta&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dispersión: Real vs Predicho (TEST)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Valores Reales&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicciones&#39;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># (3) Residuos TEST en el tiempo</span>
    <span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">resid_h0</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuos del Modelo (TEST)&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tiempo&#39;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">)</span>

    <span class="c1"># (4) Histograma residuos</span>
    <span class="n">ax4</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Residuos (TEST)&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuos&#39;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>

    <span class="c1"># (5) “Importancias”: N-BEATS no tiene -&gt; vector cero (placeholder)</span>
    <span class="n">ax5</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_feats</span> <span class="o">=</span> <span class="n">y_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">LOOKBACK</span>  <span class="c1"># placeholder</span>
    <span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;feat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">)]</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">LOOKBACK</span><span class="p">)</span>
    <span class="n">top_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">zeros</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
    <span class="n">fi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feat_names</span><span class="p">)[</span><span class="n">top_idx</span><span class="p">],</span><span class="s2">&quot;importance&quot;</span><span class="p">:</span><span class="n">zeros</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)),</span> <span class="n">fi</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)));</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importancia&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 10 Features Importantes&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># (6) Caja de métricas Val (single-point como el resto)</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
    <span class="k">def</span> <span class="nf">_RMSE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
    <span class="k">def</span> <span class="nf">_MAE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">_MAPE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
        <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">);</span> <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">eps</span><span class="p">))</span>
    <span class="n">ax6</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mape_val</span><span class="o">=</span><span class="n">_MAPE</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_va_pred</span><span class="p">);</span> <span class="n">mae_val</span><span class="o">=</span><span class="n">_MAE</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_va_pred</span><span class="p">);</span> <span class="n">rmse_val</span><span class="o">=</span><span class="n">_RMSE</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_va_pred</span><span class="p">)</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([[</span><span class="n">mape_val</span><span class="p">],[</span><span class="n">mae_val</span><span class="p">],[</span><span class="n">rmse_val</span><span class="p">]],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">,</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Métricas CV (Validación)&#39;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>

    <span class="c1"># (7) Q-Q plot residuos TEST</span>
    <span class="n">ax7</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid_h0</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">ax7</span><span class="p">);</span> <span class="n">ax7</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot de Residuos (TEST)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Análisis General - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> - Series Temporales&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># ===== Figura por conjunto (TRAIN / VAL / TEST) =====</span>
    <span class="n">fig2</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Train)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Train)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_tr_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TRAIN - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span> <span class="n">y_va</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Val)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span> <span class="n">y_va_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Val)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">val_dates</span><span class="p">,</span> <span class="n">y_va</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_va_pred</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto VALIDATION - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_REAL</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real (Test)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">],</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_PRED</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pred (Test - mean MC)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lo_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hi_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">lo_band</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">hi_band</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Banda 90%&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="n">y_te</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_te_pred_mean</span><span class="p">[:,</span><span class="n">H_GRAPH</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">COL_ERR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conjunto TEST - Último fold&#39;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== N-BEATS: métricas + gráficas estilo compañera =====</span>

<span class="c1"># 1) Predicciones puntuales en TRAIN/VAL usando el modelo seleccionado por Val</span>
<span class="n">Ytr_true</span><span class="p">,</span> <span class="n">Ytr_pred</span> <span class="o">=</span> <span class="n">preds_point</span><span class="p">(</span><span class="n">nbeats</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">)</span>
<span class="n">Yva_true</span><span class="p">,</span> <span class="n">Yva_pred</span> <span class="o">=</span> <span class="n">preds_point</span><span class="p">(</span><span class="n">nbeats</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span>   <span class="n">DEVICE</span><span class="p">)</span>

<span class="c1"># 2) TEST: usamos la media MC del modelo reentrenado (nb_final)</span>
<span class="c1">#Yte_true = np.vstack([y for _, y in test_loader.dataset])  # ya lo tienes arriba como Ytest</span>
<span class="n">Yte_true</span> <span class="o">=</span> <span class="n">Ytest</span>  <span class="c1"># ✅ Datos con forma correcta (206,7,2)</span>
<span class="n">Yte_mean</span> <span class="o">=</span> <span class="n">mean_te</span>                                         <span class="c1"># media MC ya calculada</span>
<span class="c1"># banda 90%: prioriza la calibrada si la tienes</span>
<span class="n">Yte_lo</span> <span class="o">=</span> <span class="n">lo_te_cal</span> <span class="k">if</span> <span class="s1">&#39;lo_te_cal&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">else</span> <span class="n">lo_te_mc</span>
<span class="n">Yte_hi</span> <span class="o">=</span> <span class="n">hi_te_cal</span> <span class="k">if</span> <span class="s1">&#39;hi_te_cal&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">else</span> <span class="n">hi_te_mc</span>

<span class="c1"># 3) Métricas y BDS (coinciden con el resto)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[N-BEATS] Métricas&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span><span class="p">,(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:(</span><span class="n">Ytr_true</span><span class="p">,</span><span class="n">Ytr_pred</span><span class="p">),</span><span class="s2">&quot;Val&quot;</span><span class="p">:(</span><span class="n">Yva_true</span><span class="p">,</span><span class="n">Yva_pred</span><span class="p">),</span><span class="s2">&quot;Test&quot;</span><span class="p">:(</span><span class="n">Yte_true</span><span class="p">,</span><span class="n">Yte_mean</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">line</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">:</span><span class="s2">&gt;5</span><span class="si">}</span><span class="s2">: MAPE=</span><span class="si">{</span><span class="n">MAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% | MAE=</span><span class="si">{</span><span class="n">MAE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | RMSE=</span><span class="si">{</span><span class="n">RMSE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">!=</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot; | sMAPE=</span><span class="si">{</span><span class="n">sMAPE</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[N-BEATS] BDS (residuos TEST, h=t+1):&quot;</span><span class="p">,</span> <span class="n">run_bds</span><span class="p">(</span><span class="n">Yte_true</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Yte_mean</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_dim</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># 4) Gráficas (idénticas al resto, con banda 90% en TEST)</span>
<span class="n">plot_like_partner_nbeats</span><span class="p">(</span><span class="s2">&quot;N-BEATS (Bayesian MC-Dropout)&quot;</span><span class="p">,</span>
                         <span class="n">Ytr_true</span><span class="p">,</span> <span class="n">Ytr_pred</span><span class="p">,</span> <span class="n">Yva_true</span><span class="p">,</span> <span class="n">Yva_pred</span><span class="p">,</span>
                         <span class="n">Yte_true</span><span class="p">,</span> <span class="n">Yte_mean</span><span class="p">,</span>
                         <span class="n">df</span><span class="p">,</span> <span class="n">LOOKBACK</span><span class="p">,</span>
                         <span class="n">lo_band</span><span class="o">=</span><span class="n">Yte_lo</span><span class="p">,</span> <span class="n">hi_band</span><span class="o">=</span><span class="n">Yte_hi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[N-BEATS] Métricas
Train: MAPE=9608445.1482% | MAE=0.898658 | RMSE=1.174409
  Val: MAPE=9446526.8632% | MAE=0.901313 | RMSE=1.224186 | sMAPE=117.25%
 Test: MAPE=52811243.6957% | MAE=0.746676 | RMSE=1.197628 | sMAPE=78.78%
[N-BEATS] BDS (residuos TEST, h=t+1): m=2: p=2.65e-09 | m=3: p=1.41e-35 | m=4: p=3.74e-43 | m=5: p=5.06e-47 | m=6: p=3.08e-48 || Rechazamos H0 — residuos NO independientes.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1909965028.py:119: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  ax6.boxplot([[mape_val],[mae_val],[rmse_val]], labels=[&#39;MAPE&#39;,&#39;MAE&#39;,&#39;RMSE&#39;])
/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/1909965028.py:126: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout(); plt.show()
</pre></div>
</div>
<img alt="_images/ff99d304b94610446d945b5054710d014f11e1af550f6de3690e53967ff18f9c.png" src="_images/ff99d304b94610446d945b5054710d014f11e1af550f6de3690e53967ff18f9c.png" />
<img alt="_images/cf44c7e8a4b0b012ecb8859957467b2969439fc5348e9a8f9221ee80b41b003e.png" src="_images/cf44c7e8a4b0b012ecb8859957467b2969439fc5348e9a8f9221ee80b41b003e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Primero define h (el horizonte que quieres analizar)</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Por ejemplo, para t+1</span>

<span class="c1"># Luego necesitas aplanar o seleccionar una sola columna</span>
<span class="c1"># Si quieres analizar solo una de las dos salidas (lat o lon):</span>
<span class="n">output_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0 para la primera salida, 1 para la segunda</span>

<span class="n">LO</span> <span class="o">=</span> <span class="n">lo_te_cal</span><span class="p">[:,</span> <span class="n">h</span><span class="p">,</span> <span class="n">output_idx</span><span class="p">]</span>    <span class="c1"># Ahora es 1D</span>
<span class="n">HI</span> <span class="o">=</span> <span class="n">hi_te_cal</span><span class="p">[:,</span> <span class="n">h</span><span class="p">,</span> <span class="n">output_idx</span><span class="p">]</span>    <span class="c1"># Ahora es 1D</span>
<span class="n">PRED</span> <span class="o">=</span> <span class="n">mean_te</span><span class="p">[:,</span> <span class="n">h</span><span class="p">,</span> <span class="n">output_idx</span><span class="p">]</span>    <span class="c1"># Ahora es 1D</span>
<span class="n">TRUE</span> <span class="o">=</span> <span class="n">Ytest</span><span class="p">[:,</span> <span class="n">h</span><span class="p">,</span> <span class="n">output_idx</span><span class="p">]</span>      <span class="c1"># Ahora es 1D</span>

<span class="n">width</span> <span class="o">=</span> <span class="n">HI</span> <span class="o">-</span> <span class="n">LO</span>
<span class="n">half</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">TRUE</span> <span class="o">&gt;=</span> <span class="n">LO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">&lt;=</span> <span class="n">HI</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ancho medio de banda (h=t+</span><span class="si">{</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">width</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Radio medio (±):                 ±</span><span class="si">{</span><span class="n">half</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cuantiles del ancho (10/50/90%):&quot;</span><span class="p">,</span>
      <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">])])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coverage empírico:               </span><span class="si">{</span><span class="n">cov</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Tabla por fecha con lo/hi</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">last_block_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">TRUE</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">intervals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;ds&quot;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
    <span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="s2">&quot;y_pred_mean&quot;</span><span class="p">:</span> <span class="n">PRED</span><span class="p">,</span>
    <span class="s2">&quot;lo&quot;</span><span class="p">:</span> <span class="n">LO</span><span class="p">,</span>
    <span class="s2">&quot;hi&quot;</span><span class="p">:</span> <span class="n">HI</span><span class="p">,</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
    <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="n">half</span><span class="p">,</span>
    <span class="s2">&quot;inside_90&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">&gt;=</span> <span class="n">LO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">&lt;=</span> <span class="n">HI</span><span class="p">),</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">intervals_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ancho medio de banda (h=t+1): 3.454781
Radio medio (±):                 ±1.727390
Cuantiles del ancho (10/50/90%): [&#39;3.454782&#39;, &#39;3.454782&#39;, &#39;3.454782&#39;]
Coverage empírico:               0.888
   ds    y_true  y_pred_mean        lo        hi     width  half_width  \
0   0  1.279340     0.168336 -1.559054  1.895727  3.454782    1.727391   
1   1  1.428899     0.131347 -1.596043  1.858738  3.454782    1.727391   
2   2  1.425486     0.337194 -1.390197  2.064585  3.454782    1.727391   
3   3  1.425486     0.407105 -1.320286  2.134496  3.454782    1.727391   
4   4  1.343997     0.392546 -1.334844  2.119937  3.454782    1.727391   
5   5 -0.540420    -0.658330 -2.385721  1.069061  3.454782    1.727391   
6   6 -0.588003    -0.651718 -2.379108  1.075673  3.454782    1.727391   
7   7 -0.588003    -0.653598 -2.380989  1.073793  3.454782    1.727391   
8   8 -0.588003    -0.131531 -1.858921  1.595860  3.454782    1.727391   
9   9 -0.620250    -0.191695 -1.919086  1.535696  3.454782    1.727391   

   inside_90  
0       True  
1       True  
2       True  
3       True  
4       True  
5       True  
6       True  
7       True  
8       True  
9       True  
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="resultados">
<h1>Resultados<a class="headerlink" href="#resultados" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># === Datos de Train ===</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Modelo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;KNN&quot;</span><span class="p">,</span> <span class="s2">&quot;Decision Tree&quot;</span><span class="p">,</span> <span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span> <span class="s2">&quot;XGBoost&quot;</span><span class="p">,</span> <span class="s2">&quot;SVR (RBF)&quot;</span><span class="p">,</span> <span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="s2">&quot;RNN&quot;</span><span class="p">,</span> <span class="s2">&quot;LSTM&quot;</span><span class="p">,</span> <span class="s2">&quot;N-BEATS&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Train MAPE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;61.6277%&quot;</span><span class="p">,</span> <span class="s2">&quot;60923442.5139%&quot;</span><span class="p">,</span> <span class="s2">&quot;18071639.7888%&quot;</span><span class="p">,</span> <span class="s2">&quot;36936.3070%&quot;</span><span class="p">,</span> <span class="s2">&quot;1788404.9668%&quot;</span><span class="p">,</span> <span class="s2">&quot;7219044.7557%&quot;</span><span class="p">,</span> <span class="s2">&quot;57602076.0738%&quot;</span><span class="p">,</span> <span class="s2">&quot;22668965.4429%&quot;</span><span class="p">,</span> <span class="s2">&quot;9608445.1482%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Train MAE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.000001</span><span class="p">,</span> <span class="mf">0.593727</span><span class="p">,</span> <span class="mf">0.176111</span><span class="p">,</span> <span class="mf">0.000297</span><span class="p">,</span> <span class="mf">0.016497</span><span class="p">,</span> <span class="mf">0.862112</span><span class="p">,</span> <span class="mf">0.476071</span><span class="p">,</span> <span class="mf">0.214995</span><span class="p">,</span> <span class="mf">0.898658</span><span class="p">],</span>
    <span class="s2">&quot;Train RMSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.000004</span><span class="p">,</span> <span class="mf">0.880555</span><span class="p">,</span> <span class="mf">0.295977</span><span class="p">,</span> <span class="mf">0.000358</span><span class="p">,</span> <span class="mf">0.020847</span><span class="p">,</span> <span class="mf">1.188377</span><span class="p">,</span> <span class="mf">0.758783</span><span class="p">,</span> <span class="mf">0.376890</span><span class="p">,</span> <span class="mf">1.174409</span><span class="p">],</span>
    <span class="s2">&quot;Train MSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.000000016</span><span class="p">,</span> <span class="mf">0.775377</span><span class="p">,</span> <span class="mf">0.087602</span><span class="p">,</span> <span class="mf">0.000128</span><span class="p">,</span> <span class="mf">0.000434</span><span class="p">,</span> <span class="mf">1.412240</span><span class="p">,</span> <span class="mf">0.575752</span><span class="p">,</span> <span class="mf">0.142046</span><span class="p">,</span> <span class="mf">1.379237</span><span class="p">],</span>
    <span class="s2">&quot;BDS Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> 
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">]</span>
<span class="p">})</span>

<span class="c1"># === Datos de Validation ===</span>
<span class="n">df_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Modelo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;KNN&quot;</span><span class="p">,</span> <span class="s2">&quot;Decision Tree&quot;</span><span class="p">,</span> <span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span> <span class="s2">&quot;XGBoost&quot;</span><span class="p">,</span> <span class="s2">&quot;SVR (RBF)&quot;</span><span class="p">,</span> <span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="s2">&quot;RNN&quot;</span><span class="p">,</span> <span class="s2">&quot;LSTM&quot;</span><span class="p">,</span> <span class="s2">&quot;N-BEATS&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Val MAPE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;23072942.2392%&quot;</span><span class="p">,</span> <span class="s2">&quot;68007300.0792%&quot;</span><span class="p">,</span> <span class="s2">&quot;30454236.9005%&quot;</span><span class="p">,</span> <span class="s2">&quot;18534984.1555%&quot;</span><span class="p">,</span> <span class="s2">&quot;33603197.6966%&quot;</span><span class="p">,</span> <span class="s2">&quot;7681957.0419%&quot;</span><span class="p">,</span> <span class="s2">&quot;60909076.6167%&quot;</span><span class="p">,</span> <span class="s2">&quot;31433284.9546%&quot;</span><span class="p">,</span> <span class="s2">&quot;9446526.8632%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Val MAE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.196383</span><span class="p">,</span> <span class="mf">0.616334</span><span class="p">,</span> <span class="mf">0.271871</span><span class="p">,</span> <span class="mf">0.146771</span><span class="p">,</span> <span class="mf">0.282873</span><span class="p">,</span> <span class="mf">0.862310</span><span class="p">,</span> <span class="mf">0.502106</span><span class="p">,</span> <span class="mf">0.281827</span><span class="p">,</span> <span class="mf">0.901313</span><span class="p">],</span>
    <span class="s2">&quot;Val RMSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.552011</span><span class="p">,</span> <span class="mf">0.949099</span><span class="p">,</span> <span class="mf">0.570564</span><span class="p">,</span> <span class="mf">0.517411</span><span class="p">,</span> <span class="mf">0.673387</span><span class="p">,</span> <span class="mf">1.238791</span><span class="p">,</span> <span class="mf">0.831701</span><span class="p">,</span> <span class="mf">0.539617</span><span class="p">,</span> <span class="mf">1.224186</span><span class="p">],</span>
    <span class="s2">&quot;Val MSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.304716</span><span class="p">,</span> <span class="mf">0.900789</span><span class="p">,</span> <span class="mf">0.325543</span><span class="p">,</span> <span class="mf">0.267714</span><span class="p">,</span> <span class="mf">0.453450</span><span class="p">,</span> <span class="mf">1.534603</span><span class="p">,</span> <span class="mf">0.691726</span><span class="p">,</span> <span class="mf">0.291186</span><span class="p">,</span> <span class="mf">1.498631</span><span class="p">],</span>
    <span class="s2">&quot;Val sMAPE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;23.04%&quot;</span><span class="p">,</span> <span class="s2">&quot;63.05%&quot;</span><span class="p">,</span> <span class="s2">&quot;30.58%&quot;</span><span class="p">,</span> <span class="s2">&quot;17.41%&quot;</span><span class="p">,</span> <span class="s2">&quot;31.18%&quot;</span><span class="p">,</span> <span class="s2">&quot;116.85%&quot;</span><span class="p">,</span> <span class="s2">&quot;53.39%&quot;</span><span class="p">,</span> <span class="s2">&quot;31.54%&quot;</span><span class="p">,</span> <span class="s2">&quot;117.25%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;BDS Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> 
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">]</span>
<span class="p">})</span>

<span class="c1"># === Datos de Test ===</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Modelo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;KNN&quot;</span><span class="p">,</span> <span class="s2">&quot;Decision Tree&quot;</span><span class="p">,</span> <span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span> <span class="s2">&quot;XGBoost&quot;</span><span class="p">,</span> <span class="s2">&quot;SVR (RBF)&quot;</span><span class="p">,</span> <span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="s2">&quot;RNN&quot;</span><span class="p">,</span> <span class="s2">&quot;LSTM&quot;</span><span class="p">,</span> <span class="s2">&quot;N-BEATS&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test MAPE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;39938595.3365%&quot;</span><span class="p">,</span> <span class="s2">&quot;62111948.2259%&quot;</span><span class="p">,</span> <span class="s2">&quot;32281029.6121%&quot;</span><span class="p">,</span> <span class="s2">&quot;24877618.7023%&quot;</span><span class="p">,</span> <span class="s2">&quot;48926776.8399%&quot;</span><span class="p">,</span> <span class="s2">&quot;8623678.1473%&quot;</span><span class="p">,</span> <span class="s2">&quot;61465484.3764%&quot;</span><span class="p">,</span> <span class="s2">&quot;35681257.9861%&quot;</span><span class="p">,</span> <span class="s2">&quot;52811243.6957%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test MAE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.169211</span><span class="p">,</span> <span class="mf">0.576209</span><span class="p">,</span> <span class="mf">0.232165</span><span class="p">,</span> <span class="mf">0.147315</span><span class="p">,</span> <span class="mf">0.322745</span><span class="p">,</span> <span class="mf">0.859353</span><span class="p">,</span> <span class="mf">0.456823</span><span class="p">,</span> <span class="mf">0.232375</span><span class="p">,</span> <span class="mf">0.746676</span><span class="p">],</span>
    <span class="s2">&quot;Test RMSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.535271</span><span class="p">,</span> <span class="mf">1.004173</span><span class="p">,</span> <span class="mf">0.565599</span><span class="p">,</span> <span class="mf">0.510887</span><span class="p">,</span> <span class="mf">0.739414</span><span class="p">,</span> <span class="mf">1.231493</span><span class="p">,</span> <span class="mf">0.790216</span><span class="p">,</span> <span class="mf">0.485876</span><span class="p">,</span> <span class="mf">1.197628</span><span class="p">],</span>
    <span class="s2">&quot;Test MSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.286515</span><span class="p">,</span> <span class="mf">1.008363</span><span class="p">,</span> <span class="mf">0.319902</span><span class="p">,</span> <span class="mf">0.261005</span><span class="p">,</span> <span class="mf">0.546733</span><span class="p">,</span> <span class="mf">1.516575</span><span class="p">,</span> <span class="mf">0.624441</span><span class="p">,</span> <span class="mf">0.236076</span><span class="p">,</span> <span class="mf">1.434313</span><span class="p">],</span>
    <span class="s2">&quot;Test sMAPE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;19.10%&quot;</span><span class="p">,</span> <span class="s2">&quot;58.62%&quot;</span><span class="p">,</span> <span class="s2">&quot;26.19%&quot;</span><span class="p">,</span> <span class="s2">&quot;17.48%&quot;</span><span class="p">,</span> <span class="s2">&quot;33.70%&quot;</span><span class="p">,</span> <span class="s2">&quot;116.27%&quot;</span><span class="p">,</span> <span class="s2">&quot;49.71%&quot;</span><span class="p">,</span> <span class="s2">&quot;27.64%&quot;</span><span class="p">,</span> <span class="s2">&quot;78.78%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;BDS Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> 
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos independientes&quot;</span><span class="p">,</span> <span class="s2">&quot;Residuos NO independientes&quot;</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<section id="resultado-de-training">
<h2>Resultado de Training<a class="headerlink" href="#resultado-de-training" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>


<span class="c1"># === Columna auxiliar: 0 = independientes, 1 = NO independientes ===</span>
<span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># === Orden: primero BDS independientes, luego Train RMSE ascendente ===</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">,</span><span class="s2">&quot;Train RMSE&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># === Colores para BDS ===</span>
<span class="k">def</span> <span class="nf">highlight_bds</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;background-color:#E8F5E9; color:#1B5E20; font-weight:bold;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;background-color:#FFEBEE; color:#B71C1C; font-weight:bold;&quot;</span>

<span class="c1"># === Estilo visual ===</span>
<span class="n">styled_train</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">style</span>
        <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">highlight_bds</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">set_table_styles</span><span class="p">([</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;#4CAF50&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;14px&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;8px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;border-collapse&quot;</span><span class="p">,</span> <span class="s2">&quot;collapse&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span> <span class="s2">&quot;0 auto&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span> <span class="s2">&quot;Georgia, serif&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;13px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;6px&quot;</span><span class="p">)]}</span>
        <span class="p">])</span>
        <span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s2">&quot;Train MAE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Train RMSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Train MSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;border&quot;</span><span class="p">:</span> <span class="s2">&quot;1px solid #dddddd&quot;</span><span class="p">})</span>
<span class="p">)</span>

<span class="c1"># === Mostrar en el notebook ===</span>
<span class="n">display</span><span class="p">(</span><span class="n">styled_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/2732124800.py:21: FutureWarning: Styler.applymap has been deprecated. Use Styler.map instead.
  .applymap(highlight_bds, subset=[&quot;BDS Test&quot;])
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
#T_31346 th {
  background-color: #4CAF50;
  color: white;
  font-size: 14px;
  text-align: center;
  padding: 8px;
}
#T_31346 table {
  border-collapse: collapse;
  margin: 0 auto;
  font-family: Georgia, serif;
  font-size: 13px;
}
#T_31346 td {
  text-align: center;
  padding: 6px;
}
#T_31346_row0_col0, #T_31346_row0_col1, #T_31346_row0_col2, #T_31346_row0_col3, #T_31346_row0_col4, #T_31346_row1_col0, #T_31346_row1_col1, #T_31346_row1_col2, #T_31346_row1_col3, #T_31346_row1_col4, #T_31346_row2_col0, #T_31346_row2_col1, #T_31346_row2_col2, #T_31346_row2_col3, #T_31346_row2_col4, #T_31346_row3_col0, #T_31346_row3_col1, #T_31346_row3_col2, #T_31346_row3_col3, #T_31346_row3_col4, #T_31346_row4_col0, #T_31346_row4_col1, #T_31346_row4_col2, #T_31346_row4_col3, #T_31346_row4_col4, #T_31346_row5_col0, #T_31346_row5_col1, #T_31346_row5_col2, #T_31346_row5_col3, #T_31346_row5_col4, #T_31346_row6_col0, #T_31346_row6_col1, #T_31346_row6_col2, #T_31346_row6_col3, #T_31346_row6_col4, #T_31346_row7_col0, #T_31346_row7_col1, #T_31346_row7_col2, #T_31346_row7_col3, #T_31346_row7_col4, #T_31346_row8_col0, #T_31346_row8_col1, #T_31346_row8_col2, #T_31346_row8_col3, #T_31346_row8_col4 {
  border: 1px solid #dddddd;
}
#T_31346_row0_col5, #T_31346_row1_col5 {
  background-color: #E8F5E9;
  color: #1B5E20;
  font-weight: bold;
  border: 1px solid #dddddd;
}
#T_31346_row2_col5, #T_31346_row3_col5, #T_31346_row4_col5, #T_31346_row5_col5, #T_31346_row6_col5, #T_31346_row7_col5, #T_31346_row8_col5 {
  background-color: #FFEBEE;
  color: #B71C1C;
  font-weight: bold;
  border: 1px solid #dddddd;
}
</style>
<table id="T_31346">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_31346_level0_col0" class="col_heading level0 col0" >Modelo</th>
      <th id="T_31346_level0_col1" class="col_heading level0 col1" >Train MAPE</th>
      <th id="T_31346_level0_col2" class="col_heading level0 col2" >Train MAE</th>
      <th id="T_31346_level0_col3" class="col_heading level0 col3" >Train RMSE</th>
      <th id="T_31346_level0_col4" class="col_heading level0 col4" >Train MSE</th>
      <th id="T_31346_level0_col5" class="col_heading level0 col5" >BDS Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_31346_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_31346_row0_col0" class="data row0 col0" >Random Forest</td>
      <td id="T_31346_row0_col1" class="data row0 col1" >18071639.7888%</td>
      <td id="T_31346_row0_col2" class="data row0 col2" >0.176111</td>
      <td id="T_31346_row0_col3" class="data row0 col3" >0.295977</td>
      <td id="T_31346_row0_col4" class="data row0 col4" >0.087602</td>
      <td id="T_31346_row0_col5" class="data row0 col5" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_31346_row1_col0" class="data row1 col0" >LSTM</td>
      <td id="T_31346_row1_col1" class="data row1 col1" >22668965.4429%</td>
      <td id="T_31346_row1_col2" class="data row1 col2" >0.214995</td>
      <td id="T_31346_row1_col3" class="data row1 col3" >0.376890</td>
      <td id="T_31346_row1_col4" class="data row1 col4" >0.142046</td>
      <td id="T_31346_row1_col5" class="data row1 col5" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_31346_row2_col0" class="data row2 col0" >KNN</td>
      <td id="T_31346_row2_col1" class="data row2 col1" >61.6277%</td>
      <td id="T_31346_row2_col2" class="data row2 col2" >0.000001</td>
      <td id="T_31346_row2_col3" class="data row2 col3" >0.000004</td>
      <td id="T_31346_row2_col4" class="data row2 col4" >0.000000</td>
      <td id="T_31346_row2_col5" class="data row2 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_31346_row3_col0" class="data row3 col0" >XGBoost</td>
      <td id="T_31346_row3_col1" class="data row3 col1" >36936.3070%</td>
      <td id="T_31346_row3_col2" class="data row3 col2" >0.000297</td>
      <td id="T_31346_row3_col3" class="data row3 col3" >0.000358</td>
      <td id="T_31346_row3_col4" class="data row3 col4" >0.000128</td>
      <td id="T_31346_row3_col5" class="data row3 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_31346_row4_col0" class="data row4 col0" >SVR (RBF)</td>
      <td id="T_31346_row4_col1" class="data row4 col1" >1788404.9668%</td>
      <td id="T_31346_row4_col2" class="data row4 col2" >0.016497</td>
      <td id="T_31346_row4_col3" class="data row4 col3" >0.020847</td>
      <td id="T_31346_row4_col4" class="data row4 col4" >0.000434</td>
      <td id="T_31346_row4_col5" class="data row4 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_31346_row5_col0" class="data row5 col0" >RNN</td>
      <td id="T_31346_row5_col1" class="data row5 col1" >57602076.0738%</td>
      <td id="T_31346_row5_col2" class="data row5 col2" >0.476071</td>
      <td id="T_31346_row5_col3" class="data row5 col3" >0.758783</td>
      <td id="T_31346_row5_col4" class="data row5 col4" >0.575752</td>
      <td id="T_31346_row5_col5" class="data row5 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_31346_row6_col0" class="data row6 col0" >Decision Tree</td>
      <td id="T_31346_row6_col1" class="data row6 col1" >60923442.5139%</td>
      <td id="T_31346_row6_col2" class="data row6 col2" >0.593727</td>
      <td id="T_31346_row6_col3" class="data row6 col3" >0.880555</td>
      <td id="T_31346_row6_col4" class="data row6 col4" >0.775377</td>
      <td id="T_31346_row6_col5" class="data row6 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_31346_row7_col0" class="data row7 col0" >N-BEATS</td>
      <td id="T_31346_row7_col1" class="data row7 col1" >9608445.1482%</td>
      <td id="T_31346_row7_col2" class="data row7 col2" >0.898658</td>
      <td id="T_31346_row7_col3" class="data row7 col3" >1.174409</td>
      <td id="T_31346_row7_col4" class="data row7 col4" >1.379237</td>
      <td id="T_31346_row7_col5" class="data row7 col5" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_31346_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_31346_row8_col0" class="data row8 col0" >MLP</td>
      <td id="T_31346_row8_col1" class="data row8 col1" >7219044.7557%</td>
      <td id="T_31346_row8_col2" class="data row8 col2" >0.862112</td>
      <td id="T_31346_row8_col3" class="data row8 col3" >1.188377</td>
      <td id="T_31346_row8_col4" class="data row8 col4" >1.412240</td>
      <td id="T_31346_row8_col5" class="data row8 col5" >Residuos NO independientes</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="resultado-validacion">
<h2>Resultado validación<a class="headerlink" href="#resultado-validacion" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>


<span class="c1"># === Orden combinado: BDS (independientes primero) + Val RMSE ascendente ===</span>
<span class="n">df_val</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_val</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df_val</span> <span class="o">=</span> <span class="n">df_val</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">,</span> <span class="s2">&quot;Val RMSE&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># === Colores para BDS ===</span>
<span class="k">def</span> <span class="nf">highlight_bds</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;background-color:#E8F5E9; color:#1B5E20; font-weight:bold;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;background-color:#FFEBEE; color:#B71C1C; font-weight:bold;&quot;</span>

<span class="c1"># === Estilo ===</span>
<span class="n">styled_val</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_val</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">])</span>   <span class="c1"># ocultar columna auxiliar</span>
        <span class="o">.</span><span class="n">style</span>
        <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">highlight_bds</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">set_table_styles</span><span class="p">([</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;#4CAF50&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;14px&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;8px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;border-collapse&quot;</span><span class="p">,</span> <span class="s2">&quot;collapse&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span> <span class="s2">&quot;0 auto&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span> <span class="s2">&quot;Georgia, serif&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;13px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;6px&quot;</span><span class="p">)]}</span>
        <span class="p">])</span>
        <span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s2">&quot;Val MAE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Val RMSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Val MSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;border&quot;</span><span class="p">:</span> <span class="s2">&quot;1px solid #dddddd&quot;</span><span class="p">})</span>
<span class="p">)</span>

<span class="c1"># === Mostrar en el notebook ===</span>
<span class="n">display</span><span class="p">(</span><span class="n">styled_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/4037125152.py:19: FutureWarning: Styler.applymap has been deprecated. Use Styler.map instead.
  .applymap(highlight_bds, subset=[&quot;BDS Test&quot;])
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
#T_8f822 th {
  background-color: #4CAF50;
  color: white;
  font-size: 14px;
  text-align: center;
  padding: 8px;
}
#T_8f822 table {
  border-collapse: collapse;
  margin: 0 auto;
  font-family: Georgia, serif;
  font-size: 13px;
}
#T_8f822 td {
  text-align: center;
  padding: 6px;
}
#T_8f822_row0_col0, #T_8f822_row0_col1, #T_8f822_row0_col2, #T_8f822_row0_col3, #T_8f822_row0_col4, #T_8f822_row0_col5, #T_8f822_row1_col0, #T_8f822_row1_col1, #T_8f822_row1_col2, #T_8f822_row1_col3, #T_8f822_row1_col4, #T_8f822_row1_col5, #T_8f822_row2_col0, #T_8f822_row2_col1, #T_8f822_row2_col2, #T_8f822_row2_col3, #T_8f822_row2_col4, #T_8f822_row2_col5, #T_8f822_row3_col0, #T_8f822_row3_col1, #T_8f822_row3_col2, #T_8f822_row3_col3, #T_8f822_row3_col4, #T_8f822_row3_col5, #T_8f822_row4_col0, #T_8f822_row4_col1, #T_8f822_row4_col2, #T_8f822_row4_col3, #T_8f822_row4_col4, #T_8f822_row4_col5, #T_8f822_row5_col0, #T_8f822_row5_col1, #T_8f822_row5_col2, #T_8f822_row5_col3, #T_8f822_row5_col4, #T_8f822_row5_col5, #T_8f822_row6_col0, #T_8f822_row6_col1, #T_8f822_row6_col2, #T_8f822_row6_col3, #T_8f822_row6_col4, #T_8f822_row6_col5, #T_8f822_row7_col0, #T_8f822_row7_col1, #T_8f822_row7_col2, #T_8f822_row7_col3, #T_8f822_row7_col4, #T_8f822_row7_col5, #T_8f822_row8_col0, #T_8f822_row8_col1, #T_8f822_row8_col2, #T_8f822_row8_col3, #T_8f822_row8_col4, #T_8f822_row8_col5 {
  border: 1px solid #dddddd;
}
#T_8f822_row0_col6, #T_8f822_row1_col6 {
  background-color: #E8F5E9;
  color: #1B5E20;
  font-weight: bold;
  border: 1px solid #dddddd;
}
#T_8f822_row2_col6, #T_8f822_row3_col6, #T_8f822_row4_col6, #T_8f822_row5_col6, #T_8f822_row6_col6, #T_8f822_row7_col6, #T_8f822_row8_col6 {
  background-color: #FFEBEE;
  color: #B71C1C;
  font-weight: bold;
  border: 1px solid #dddddd;
}
</style>
<table id="T_8f822">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_8f822_level0_col0" class="col_heading level0 col0" >Modelo</th>
      <th id="T_8f822_level0_col1" class="col_heading level0 col1" >Val MAPE</th>
      <th id="T_8f822_level0_col2" class="col_heading level0 col2" >Val MAE</th>
      <th id="T_8f822_level0_col3" class="col_heading level0 col3" >Val RMSE</th>
      <th id="T_8f822_level0_col4" class="col_heading level0 col4" >Val MSE</th>
      <th id="T_8f822_level0_col5" class="col_heading level0 col5" >Val sMAPE</th>
      <th id="T_8f822_level0_col6" class="col_heading level0 col6" >BDS Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_8f822_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_8f822_row0_col0" class="data row0 col0" >LSTM</td>
      <td id="T_8f822_row0_col1" class="data row0 col1" >31433284.9546%</td>
      <td id="T_8f822_row0_col2" class="data row0 col2" >0.281827</td>
      <td id="T_8f822_row0_col3" class="data row0 col3" >0.539617</td>
      <td id="T_8f822_row0_col4" class="data row0 col4" >0.291186</td>
      <td id="T_8f822_row0_col5" class="data row0 col5" >31.54%</td>
      <td id="T_8f822_row0_col6" class="data row0 col6" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_8f822_row1_col0" class="data row1 col0" >Random Forest</td>
      <td id="T_8f822_row1_col1" class="data row1 col1" >30454236.9005%</td>
      <td id="T_8f822_row1_col2" class="data row1 col2" >0.271871</td>
      <td id="T_8f822_row1_col3" class="data row1 col3" >0.570564</td>
      <td id="T_8f822_row1_col4" class="data row1 col4" >0.325543</td>
      <td id="T_8f822_row1_col5" class="data row1 col5" >30.58%</td>
      <td id="T_8f822_row1_col6" class="data row1 col6" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_8f822_row2_col0" class="data row2 col0" >XGBoost</td>
      <td id="T_8f822_row2_col1" class="data row2 col1" >18534984.1555%</td>
      <td id="T_8f822_row2_col2" class="data row2 col2" >0.146771</td>
      <td id="T_8f822_row2_col3" class="data row2 col3" >0.517411</td>
      <td id="T_8f822_row2_col4" class="data row2 col4" >0.267714</td>
      <td id="T_8f822_row2_col5" class="data row2 col5" >17.41%</td>
      <td id="T_8f822_row2_col6" class="data row2 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_8f822_row3_col0" class="data row3 col0" >KNN</td>
      <td id="T_8f822_row3_col1" class="data row3 col1" >23072942.2392%</td>
      <td id="T_8f822_row3_col2" class="data row3 col2" >0.196383</td>
      <td id="T_8f822_row3_col3" class="data row3 col3" >0.552011</td>
      <td id="T_8f822_row3_col4" class="data row3 col4" >0.304716</td>
      <td id="T_8f822_row3_col5" class="data row3 col5" >23.04%</td>
      <td id="T_8f822_row3_col6" class="data row3 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_8f822_row4_col0" class="data row4 col0" >SVR (RBF)</td>
      <td id="T_8f822_row4_col1" class="data row4 col1" >33603197.6966%</td>
      <td id="T_8f822_row4_col2" class="data row4 col2" >0.282873</td>
      <td id="T_8f822_row4_col3" class="data row4 col3" >0.673387</td>
      <td id="T_8f822_row4_col4" class="data row4 col4" >0.453450</td>
      <td id="T_8f822_row4_col5" class="data row4 col5" >31.18%</td>
      <td id="T_8f822_row4_col6" class="data row4 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_8f822_row5_col0" class="data row5 col0" >RNN</td>
      <td id="T_8f822_row5_col1" class="data row5 col1" >60909076.6167%</td>
      <td id="T_8f822_row5_col2" class="data row5 col2" >0.502106</td>
      <td id="T_8f822_row5_col3" class="data row5 col3" >0.831701</td>
      <td id="T_8f822_row5_col4" class="data row5 col4" >0.691726</td>
      <td id="T_8f822_row5_col5" class="data row5 col5" >53.39%</td>
      <td id="T_8f822_row5_col6" class="data row5 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_8f822_row6_col0" class="data row6 col0" >Decision Tree</td>
      <td id="T_8f822_row6_col1" class="data row6 col1" >68007300.0792%</td>
      <td id="T_8f822_row6_col2" class="data row6 col2" >0.616334</td>
      <td id="T_8f822_row6_col3" class="data row6 col3" >0.949099</td>
      <td id="T_8f822_row6_col4" class="data row6 col4" >0.900789</td>
      <td id="T_8f822_row6_col5" class="data row6 col5" >63.05%</td>
      <td id="T_8f822_row6_col6" class="data row6 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_8f822_row7_col0" class="data row7 col0" >N-BEATS</td>
      <td id="T_8f822_row7_col1" class="data row7 col1" >9446526.8632%</td>
      <td id="T_8f822_row7_col2" class="data row7 col2" >0.901313</td>
      <td id="T_8f822_row7_col3" class="data row7 col3" >1.224186</td>
      <td id="T_8f822_row7_col4" class="data row7 col4" >1.498631</td>
      <td id="T_8f822_row7_col5" class="data row7 col5" >117.25%</td>
      <td id="T_8f822_row7_col6" class="data row7 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_8f822_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_8f822_row8_col0" class="data row8 col0" >MLP</td>
      <td id="T_8f822_row8_col1" class="data row8 col1" >7681957.0419%</td>
      <td id="T_8f822_row8_col2" class="data row8 col2" >0.862310</td>
      <td id="T_8f822_row8_col3" class="data row8 col3" >1.238791</td>
      <td id="T_8f822_row8_col4" class="data row8 col4" >1.534603</td>
      <td id="T_8f822_row8_col5" class="data row8 col5" >116.85%</td>
      <td id="T_8f822_row8_col6" class="data row8 col6" >Residuos NO independientes</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="resultados-test">
<h2>Resultados Test<a class="headerlink" href="#resultados-test" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>



<span class="c1"># === Columna auxiliar para ordenar por independencia (0=independientes, 1=no) ===</span>
<span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># === Ordenar primero por BDS_flag (independientes arriba), luego por RMSE ===</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">,</span><span class="s2">&quot;Test RMSE&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># === Función de colores para BDS ===</span>
<span class="k">def</span> <span class="nf">highlight_bds</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;NO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;background-color:#E8F5E9; color:#1B5E20; font-weight:bold;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;background-color:#FFEBEE; color:#B71C1C; font-weight:bold;&quot;</span>

<span class="c1"># === Estilo ===</span>
<span class="n">styled_test</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS_flag&quot;</span><span class="p">])</span>  <span class="c1"># ya no mostramos la auxiliar</span>
        <span class="o">.</span><span class="n">style</span>
        <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">highlight_bds</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BDS Test&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">set_table_styles</span><span class="p">([</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;#4CAF50&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;14px&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;8px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;border-collapse&quot;</span><span class="p">,</span> <span class="s2">&quot;collapse&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span> <span class="s2">&quot;0 auto&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span> <span class="s2">&quot;Georgia, serif&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;13px&quot;</span><span class="p">)</span>
            <span class="p">]},</span>
            <span class="p">{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;6px&quot;</span><span class="p">)]}</span>
        <span class="p">])</span>
        <span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s2">&quot;Test MAE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Test RMSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Test MSE&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;border&quot;</span><span class="p">:</span> <span class="s2">&quot;1px solid #dddddd&quot;</span><span class="p">})</span>
<span class="p">)</span>

<span class="c1"># === Mostrar en el notebook ===</span>
<span class="n">display</span><span class="p">(</span><span class="n">styled_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/_p/446c73rj4x19qh7rmqlrf1980000gp/T/ipykernel_92315/300298435.py:22: FutureWarning: Styler.applymap has been deprecated. Use Styler.map instead.
  .applymap(highlight_bds, subset=[&quot;BDS Test&quot;])
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
#T_b4309 th {
  background-color: #4CAF50;
  color: white;
  font-size: 14px;
  text-align: center;
  padding: 8px;
}
#T_b4309 table {
  border-collapse: collapse;
  margin: 0 auto;
  font-family: Georgia, serif;
  font-size: 13px;
}
#T_b4309 td {
  text-align: center;
  padding: 6px;
}
#T_b4309_row0_col0, #T_b4309_row0_col1, #T_b4309_row0_col2, #T_b4309_row0_col3, #T_b4309_row0_col4, #T_b4309_row0_col5, #T_b4309_row1_col0, #T_b4309_row1_col1, #T_b4309_row1_col2, #T_b4309_row1_col3, #T_b4309_row1_col4, #T_b4309_row1_col5, #T_b4309_row2_col0, #T_b4309_row2_col1, #T_b4309_row2_col2, #T_b4309_row2_col3, #T_b4309_row2_col4, #T_b4309_row2_col5, #T_b4309_row3_col0, #T_b4309_row3_col1, #T_b4309_row3_col2, #T_b4309_row3_col3, #T_b4309_row3_col4, #T_b4309_row3_col5, #T_b4309_row4_col0, #T_b4309_row4_col1, #T_b4309_row4_col2, #T_b4309_row4_col3, #T_b4309_row4_col4, #T_b4309_row4_col5, #T_b4309_row5_col0, #T_b4309_row5_col1, #T_b4309_row5_col2, #T_b4309_row5_col3, #T_b4309_row5_col4, #T_b4309_row5_col5, #T_b4309_row6_col0, #T_b4309_row6_col1, #T_b4309_row6_col2, #T_b4309_row6_col3, #T_b4309_row6_col4, #T_b4309_row6_col5, #T_b4309_row7_col0, #T_b4309_row7_col1, #T_b4309_row7_col2, #T_b4309_row7_col3, #T_b4309_row7_col4, #T_b4309_row7_col5, #T_b4309_row8_col0, #T_b4309_row8_col1, #T_b4309_row8_col2, #T_b4309_row8_col3, #T_b4309_row8_col4, #T_b4309_row8_col5 {
  border: 1px solid #dddddd;
}
#T_b4309_row0_col6, #T_b4309_row1_col6 {
  background-color: #E8F5E9;
  color: #1B5E20;
  font-weight: bold;
  border: 1px solid #dddddd;
}
#T_b4309_row2_col6, #T_b4309_row3_col6, #T_b4309_row4_col6, #T_b4309_row5_col6, #T_b4309_row6_col6, #T_b4309_row7_col6, #T_b4309_row8_col6 {
  background-color: #FFEBEE;
  color: #B71C1C;
  font-weight: bold;
  border: 1px solid #dddddd;
}
</style>
<table id="T_b4309">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_b4309_level0_col0" class="col_heading level0 col0" >Modelo</th>
      <th id="T_b4309_level0_col1" class="col_heading level0 col1" >Test MAPE</th>
      <th id="T_b4309_level0_col2" class="col_heading level0 col2" >Test MAE</th>
      <th id="T_b4309_level0_col3" class="col_heading level0 col3" >Test RMSE</th>
      <th id="T_b4309_level0_col4" class="col_heading level0 col4" >Test MSE</th>
      <th id="T_b4309_level0_col5" class="col_heading level0 col5" >Test sMAPE</th>
      <th id="T_b4309_level0_col6" class="col_heading level0 col6" >BDS Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b4309_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_b4309_row0_col0" class="data row0 col0" >LSTM</td>
      <td id="T_b4309_row0_col1" class="data row0 col1" >35681257.9861%</td>
      <td id="T_b4309_row0_col2" class="data row0 col2" >0.232375</td>
      <td id="T_b4309_row0_col3" class="data row0 col3" >0.485876</td>
      <td id="T_b4309_row0_col4" class="data row0 col4" >0.236076</td>
      <td id="T_b4309_row0_col5" class="data row0 col5" >27.64%</td>
      <td id="T_b4309_row0_col6" class="data row0 col6" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_b4309_row1_col0" class="data row1 col0" >Random Forest</td>
      <td id="T_b4309_row1_col1" class="data row1 col1" >32281029.6121%</td>
      <td id="T_b4309_row1_col2" class="data row1 col2" >0.232165</td>
      <td id="T_b4309_row1_col3" class="data row1 col3" >0.565599</td>
      <td id="T_b4309_row1_col4" class="data row1 col4" >0.319902</td>
      <td id="T_b4309_row1_col5" class="data row1 col5" >26.19%</td>
      <td id="T_b4309_row1_col6" class="data row1 col6" >Residuos independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_b4309_row2_col0" class="data row2 col0" >XGBoost</td>
      <td id="T_b4309_row2_col1" class="data row2 col1" >24877618.7023%</td>
      <td id="T_b4309_row2_col2" class="data row2 col2" >0.147315</td>
      <td id="T_b4309_row2_col3" class="data row2 col3" >0.510887</td>
      <td id="T_b4309_row2_col4" class="data row2 col4" >0.261005</td>
      <td id="T_b4309_row2_col5" class="data row2 col5" >17.48%</td>
      <td id="T_b4309_row2_col6" class="data row2 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_b4309_row3_col0" class="data row3 col0" >KNN</td>
      <td id="T_b4309_row3_col1" class="data row3 col1" >39938595.3365%</td>
      <td id="T_b4309_row3_col2" class="data row3 col2" >0.169211</td>
      <td id="T_b4309_row3_col3" class="data row3 col3" >0.535271</td>
      <td id="T_b4309_row3_col4" class="data row3 col4" >0.286515</td>
      <td id="T_b4309_row3_col5" class="data row3 col5" >19.10%</td>
      <td id="T_b4309_row3_col6" class="data row3 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_b4309_row4_col0" class="data row4 col0" >SVR (RBF)</td>
      <td id="T_b4309_row4_col1" class="data row4 col1" >48926776.8399%</td>
      <td id="T_b4309_row4_col2" class="data row4 col2" >0.322745</td>
      <td id="T_b4309_row4_col3" class="data row4 col3" >0.739414</td>
      <td id="T_b4309_row4_col4" class="data row4 col4" >0.546733</td>
      <td id="T_b4309_row4_col5" class="data row4 col5" >33.70%</td>
      <td id="T_b4309_row4_col6" class="data row4 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_b4309_row5_col0" class="data row5 col0" >RNN</td>
      <td id="T_b4309_row5_col1" class="data row5 col1" >61465484.3764%</td>
      <td id="T_b4309_row5_col2" class="data row5 col2" >0.456823</td>
      <td id="T_b4309_row5_col3" class="data row5 col3" >0.790216</td>
      <td id="T_b4309_row5_col4" class="data row5 col4" >0.624441</td>
      <td id="T_b4309_row5_col5" class="data row5 col5" >49.71%</td>
      <td id="T_b4309_row5_col6" class="data row5 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_b4309_row6_col0" class="data row6 col0" >Decision Tree</td>
      <td id="T_b4309_row6_col1" class="data row6 col1" >62111948.2259%</td>
      <td id="T_b4309_row6_col2" class="data row6 col2" >0.576209</td>
      <td id="T_b4309_row6_col3" class="data row6 col3" >1.004173</td>
      <td id="T_b4309_row6_col4" class="data row6 col4" >1.008363</td>
      <td id="T_b4309_row6_col5" class="data row6 col5" >58.62%</td>
      <td id="T_b4309_row6_col6" class="data row6 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_b4309_row7_col0" class="data row7 col0" >N-BEATS</td>
      <td id="T_b4309_row7_col1" class="data row7 col1" >52811243.6957%</td>
      <td id="T_b4309_row7_col2" class="data row7 col2" >0.746676</td>
      <td id="T_b4309_row7_col3" class="data row7 col3" >1.197628</td>
      <td id="T_b4309_row7_col4" class="data row7 col4" >1.434313</td>
      <td id="T_b4309_row7_col5" class="data row7 col5" >78.78%</td>
      <td id="T_b4309_row7_col6" class="data row7 col6" >Residuos NO independientes</td>
    </tr>
    <tr>
      <th id="T_b4309_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_b4309_row8_col0" class="data row8 col0" >MLP</td>
      <td id="T_b4309_row8_col1" class="data row8 col1" >8623678.1473%</td>
      <td id="T_b4309_row8_col2" class="data row8 col2" >0.859353</td>
      <td id="T_b4309_row8_col3" class="data row8 col3" >1.231493</td>
      <td id="T_b4309_row8_col4" class="data row8 col4" >1.516575</td>
      <td id="T_b4309_row8_col5" class="data row8 col5" >116.27%</td>
      <td id="T_b4309_row8_col6" class="data row8 col6" >Residuos NO independientes</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Predecir la trayectoria e intensidad de huracanes aplicando modelos de aprendizaje automático, con enfoque en aquellos que amenacen las Islas de San Andrés y Providencia, Caribe colombiano</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objetivo-general">Objetivo General</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objetivos-especificos">Objetivos Específicos</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias">Librerías</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#etl">ETL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organizacion-del-dataframe">organización del dataframe</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajustando-las-coordenadas-a-un-formato-numerico">ajustando las coordenadas a un formato numérico</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajuste-de-los-targets-de-la-variable-type-storm-y-el-codigo-de-tormenta-code-storm">ajuste de los targets de la variable Type_storm y el Codigo de tormenta (Code_storm)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ajuste-en-los-datos-de-fecha">Ajuste en los datos de fecha</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-verifican-datos-duplicados-y-se-reemplaza-99-por-nan">Se verifican datos duplicados y se reemplaza -99 por NaN</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eliminacion-de-la-variable-rad-max-wind">Eliminación de la variable Rad_Max_wind</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#eda-1">EDA #1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datos-faltantes">Datos faltantes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploracion-de-los-radios-del-viento">Exploración de los Radios del viento</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agregar-categorias-de-huracan-type-storm-numerico">Agregar Categorias de Huracan &amp; “type_storm” numérico</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imputacion-de-presion-minima-minpress">Imputación de Presión Mínima “Minpress”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imputaciones">IMPUTACIONES</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-vector-de-longitud">Cálculo de vector de longitud</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-la-direccion-de-la-tormenta">Calculo de la dirección de la tormenta</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#generico-pruebas">Generico pruebas</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#split">Split</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-knn">Modelo KNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-decission-tree">Modelo Decission tree</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-xgboost">Modelo XGBoost</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-svr">Modelo SVR</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-mlp">Modelo MLP</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-rnn">Modelo de RNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-lstm">Modelo de LSTM</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-n-beast-bayesian">Modelo  N-Beast Bayesian</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-de-training">Resultado de Training</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-validacion">Resultado validación</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados-test">Resultados Test</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mauricio Hurtado
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>